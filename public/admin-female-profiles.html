<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Female Profiles - Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="admin-translations.js"></script>
    <link rel="stylesheet" href="admin-styles.css">
    <style>
        .profile-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            margin-bottom: 16px;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ec4899, #be185d);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
            overflow: hidden;
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: 50% 25%; /* bias slightly to upper center to show face */
            display: block;
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .profile-email {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .profile-meta {
            display: flex;
            gap: 16px;
            font-size: 12px;
            color: #9ca3af;
        }

        .profile-actions {
            display: flex;
            gap: 8px;
        }

        .profile-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .detail-label {
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .detail-value {
            font-size: 14px;
            color: #1f2937;
        }

        .approval-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .approval-status.approved {
            background: #dcfce7;
            color: #16a34a;
        }

        .approval-status.rejected {
            background: #fee2e2;
            color: #dc2626;
        }

        .approval-status.pending {
            background: #fef3c7;
            color: #d97706;
        }

        .contact-links {
            display: flex;
            gap: 12px;
            margin-top: 8px;
            font-size: 13px;
            color: #374151;
            flex-wrap: wrap;
        }
        .contact-links a {
            color: #374151;
            text-decoration: none;
        }
        .contact-links a .fa-whatsapp { color: #25D366; }
        .contact-links a .fa-envelope { color: #6b7280; }

        .media-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e5e7eb;
        }

        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .media-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .media-item img,
        .media-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .media-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .media-item:hover .media-overlay {
            opacity: 1;
        }

        .media-action {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .media-action:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Fullscreen image modal */
        .image-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        .image-modal-content img {
            height: 90vh;
            width: auto;
            max-width: 90vw;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .modal-dialog {
            background: white;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* Media modal tabs */
        .tabs {
            display: flex;
            gap: 12px;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 16px;
        }
        .tab-btn {
            background: none;
            border: none;
            padding: 10px 14px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: #6b7280;
            font-weight: 600;
        }
        .tab-btn.active {
            color: #1f2937;
            border-bottom-color: #667eea;
        }
        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
        }
        .media-card {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            background: #f3f4f6;
        }
        .media-card img,
        .media-card video {
            width: 100%;
            height: 120px;
            object-fit: cover;
            display: block;
        }
        .media-card .play-badge {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0,0,0,0.6);
            color: #fff;
            font-size: 10px;
            padding: 4px 6px;
            border-radius: 6px;
        }
        .media-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(239,68,68,0.9);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 8px;
            cursor: pointer;
            font-size: 12px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            color: #6b7280;
            cursor: pointer;
        }

        .view-mode-toggle {
            display: flex;
            background: #f3f4f6;
            border-radius: 8px;
            padding: 4px;
            gap: 4px;
        }

        .view-mode-btn {
            padding: 8px 12px;
            background: none;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            color: #6b7280;
            transition: all 0.2s ease;
        }

        .view-mode-btn.active {
            background: white;
            color: #1f2937;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .profiles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .profiles-list .profile-card {
            margin-bottom: 16px;
        }

        @media (max-width: 768px) {
            .profiles-grid {
                grid-template-columns: 1fr;
            }
            
            .profile-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .profile-actions {
                width: 100%;
                justify-content: stretch;
            }
            
            .profile-actions .btn {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-shield-alt"></i>
                    <span>Zawajplus Admin</span>
                </div>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="/admin-dashboard.html" class="nav-link">
                        <i class="fas fa-tachometer-alt"></i>
                        <span data-translate="admin.navigation.dashboard">Dashboard</span>
                    </a>
                </li>
                <li class="nav-item active">
                    <a href="/admin-female-profiles.html" class="nav-link">
                        <i class="fas fa-female"></i>
                        <span data-translate="admin.navigation.female_profiles">Female Profiles</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin-male-profiles.html" class="nav-link">
                        <i class="fas fa-male"></i>
                        <span data-translate="admin.navigation.male_profiles">Male Profiles</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin-interests.html" class="nav-link">
                        <i class="fas fa-heart"></i>
                        <span data-translate="admin.navigation.interests">Interests</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin-meet-requests.html" class="nav-link">
                        <i class="fas fa-video"></i>
                        <span data-translate="admin.navigation.meet_requests">Meet Requests</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin-packages.html" class="nav-link">
                        <i class="fas fa-box"></i>
                        <span data-translate="admin.navigation.packages">Packages</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin-management.html" class="nav-link">
                        <i class="fas fa-user-cog"></i>
                        <span data-translate="admin.navigation.admin_management">Admin Management</span>
                    </a>
                </li>
            </ul>
            
            <!-- Language Selector in Sidebar -->
            <div class="sidebar-language-selector">
                <div class="language-dropdown">
                    <button type="button" class="language-btn" onclick="toggleLanguageMenu()">
                        <span id="currentLanguage">English</span>
                        <i class="fas fa-chevron-down" style="font-size: 10px;"></i>
                    </button>
                    <div class="language-menu" id="languageMenu">
                        <div class="language-option active" data-lang="en" onclick="changeLanguage('en')">
                            <span>English</span>
                        </div>
                        <div class="language-option" data-lang="ar" onclick="changeLanguage('ar')">
                            <span>العربية</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-footer">
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span data-translate="admin.navigation.logout">Logout</span>
                </button>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <header class="top-bar">
                <div class="top-bar-left">
                    <button class="sidebar-toggle" onclick="toggleSidebar()">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title"><span data-translate="admin.profiles.female_title">Female Profiles</span> <span id="profilesCount">(0)</span></h1>
                </div>
                <div class="top-bar-right">
                    <div class="admin-info">
                        <div class="admin-details">
                            <span class="admin-name" id="adminName">Loading...</span>
                            <span class="admin-role" id="adminRole">Admin</span>
                        </div>
                        <div class="admin-avatar">
                            <i class="fas fa-user-circle"></i>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Filters -->
                <div class="filters-section">
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label class="filter-label" data-translate="admin.profiles.filters.search_label">Search</label>
                            <input 
                                type="text" 
                                id="searchInput" 
                                class="filter-input" 
                                placeholder="Search by name or email..." data-translate-placeholder="admin.profiles.filters.search_placeholder"
                                oninput="handleSearch()"
                            >
                        </div>
                        <div class="filter-group">
                            <label class="filter-label" data-translate="admin.profiles.filters.status_label">Approval Status</label>
                            <select id="approvalFilter" class="filter-select" onchange="handleFilter()">
                                <option value="" data-translate="admin.profiles.filters.status_all">All Statuses</option>
                                <option value="approved" data-translate="admin.profiles.status.approved">Approved</option>
                                <option value="rejected" data-translate="admin.profiles.status.rejected">Rejected</option>
                                <option value="pending" data-translate="admin.profiles.status.pending">Pending</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label" data-translate="admin.profiles.filters.age_range">Age Range</label>
                            <select id="ageFilter" class="filter-select" onchange="handleFilter()">
                                <option value="" data-translate="admin.profiles.filters.all_ages">All Ages</option>
                                <option value="18-25">18-25</option>
                                <option value="26-35">26-35</option>
                                <option value="36-45">36-45</option>
                                <option value="46+">46+</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label" data-translate="admin.profiles.filters.country_label">Country</label>
                            <select id="countryFilter" class="filter-select" onchange="handleFilter()">
                                <option value="" data-translate="admin.profiles.filters.all_countries">All Countries</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label" data-translate="admin.profiles.filters.date_joined_label">Date Joined</label>
                            <select id="dateFilter" class="filter-select" onchange="handleFilter()">
                                <option value="" data-translate="admin.profiles.filters.all_time">All Time</option>
                                <option value="today" data-translate="admin.profiles.filters.today">Today</option>
                                <option value="week" data-translate="admin.profiles.filters.week">This Week</option>
                                <option value="month" data-translate="admin.profiles.filters.month">This Month</option>
                                <option value="year" data-translate="admin.profiles.filters.year">This Year</option>
                            </select>
                        </div>
                    </div>
                    <div class="filters-actions">
                        <button class="btn btn-secondary" onclick="clearFilters()">
                            <i class="fas fa-times"></i>
                            <span data-translate="admin.profiles.filters.clear_filters">Clear Filters</span>
                        </button>
                        <button class="btn btn-primary" onclick="exportProfiles()">
                            <i class="fas fa-download"></i>
                            <span data-translate="admin.profiles.actions.export">Export</span>
                        </button>
                    </div>
                </div>

                <!-- Profiles Container -->
                <div id="profilesContainer" class="profiles-grid">
                    <div class="loading-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p data-translate="admin.profiles.messages.loading_female">Loading female profiles...</p>
                    </div>
                </div>

                <!-- Pagination -->
                <div id="paginationContainer" style="margin-top: 24px;"></div>
            </div>
        </main>
    </div>

    <script src="admin-common.js"></script>
    <script>
        let profiles = [];
        let filteredProfiles = [];
        let currentPage = 1;
        let itemsPerPage = 12;
        let viewMode = 'list';

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadProfiles();
        });

        async function loadProfiles() {
            const container = document.getElementById('profilesContainer');
            showTableLoading(container, 'Loading female profiles...');

            // Always use real data

            try {
                // First try RPC that includes email via security definer function
                let data = null;
                let error = null;
                try {
                    const rpcRes = await window.supabaseClient
                        .rpc('get_profiles_with_email', { in_gender: 'female' });
                    if (rpcRes.error) {
                        throw rpcRes.error;
                    }
                    data = rpcRes.data;
                } catch (rpcErr) {
                    // Fall back to plain table if RPC not available
                    const res = await window.supabaseClient
                        .from('user_profiles')
                        .select(`
                            id,
                            user_id,
                            first_name,
                            last_name,
                            gender,
                            date_of_birth,
                            country,
                            city,
                            height_cm,
                            weight_kg,
                            eye_color,
                            hair_color,
                            skin_tone,
                            body_type,
                            education_level,
                            occupation,
                            work_status,
                            housing_type,
                            living_condition,
                            phone_code,
                            mobile_number,
                            languages_spoken,
                            profile_picture_url,
                            about_me,
                            is_public,
                            admin_approved,
                            created_at,
                            updated_at
                        `)
                        .eq('gender', 'female')
                        .order('created_at', { ascending: false });
                    data = res.data;
                    error = res.error;
                }

                if (error) {
                    if (error.code === 'PGRST301' || error.message?.toLowerCase().includes('jwt') || error.message?.toLowerCase().includes('auth')) {
                        if (window.handleAuthIssue) return window.handleAuthIssue();
                    }
                    throw error;
                }

                profiles = (data || []).map(row => ({ ...row }));
                filteredProfiles = [...profiles];
                populateCountryOptions();
                renderProfiles();

            } catch (error) {
                console.error('Error loading profiles:', error);
                showTableError(container, 'Error loading female profiles');
                
                // Fallback to mock data on error
                const mockProfiles = [
                    {
                        id: 'demo-f1',
                        first_name: 'Emma',
                        last_name: 'Johnson',
                        email: 'emma.j@example.com',
                        age: 28,
                        gender: 'female',
                        bio: 'Passionate about art, travel, and meeting new people. Love hiking and outdoor adventures.',
                        location: 'New York, NY',
                        admin_approved: true,
                        created_at: new Date(Date.now() - 5 * 24 * 3600000).toISOString(),
                        updated_at: new Date(Date.now() - 2 * 24 * 3600000).toISOString()
                    },
                    {
                        id: 'demo-f2',
                        first_name: 'Sophia',
                        last_name: 'Williams',
                        email: 'sophia.w@example.com',
                        age: 24,
                        gender: 'female',
                        bio: 'Medical student with a passion for helping others. Enjoy reading and quiet evenings.',
                        location: 'Boston, MA',
                        admin_approved: true,
                        created_at: new Date(Date.now() - 10 * 24 * 3600000).toISOString(),
                        updated_at: new Date(Date.now() - 8 * 24 * 3600000).toISOString()
                    }
                ];
                
                profiles = mockProfiles;
                filteredProfiles = [...profiles];
                renderProfiles();
            }
        }

        function renderProfiles() {
            const container = document.getElementById('profilesContainer');
            
            if (filteredProfiles.length === 0) {
                showTableEmpty(container, 'No female profiles found');
                return;
            }

            // Calculate pagination
            const totalPages = Math.ceil(filteredProfiles.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const currentProfiles = filteredProfiles.slice(startIndex, endIndex);

            // Force list view
            container.className = 'profiles-list';

            // Render profiles
            container.innerHTML = currentProfiles.map(profile => `
                <div class="profile-card">
                    <div class="profile-header">
                        <div class="profile-avatar">
                            ${profile.profile_picture_url ? 
                                `<img class="avatar-img" src="${profile.profile_picture_url}" alt="${profile.first_name}"
                                      loading="lazy" decoding="async" referrerpolicy="no-referrer"
                                      style="cursor:pointer;"
                                      onclick="openAvatarFullscreen('${profile.profile_picture_url}', '${profile.first_name} ${profile.last_name}')"
                                      onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                 <div class="avatar-fallback" style="display:none;">${getInitials(profile.first_name, profile.last_name)}</div>`
                                : getInitials(profile.first_name, profile.last_name)
                            }
                        </div>
                        <div class="profile-info">
                            <div class="profile-name">
                                ${profile.first_name} ${profile.last_name}
                            </div>
                            <div class="profile-meta">
                                <span>${translateText('admin.profiles.fields.age')}: ${calculateAge(profile.date_of_birth) || 'N/A'}</span>
                                <span>${translateText('admin.profiles.fields.country')}: ${profile.country || 'N/A'}</span>
                                <span>${translateText('admin.profiles.fields.city')}: ${profile.city || 'N/A'}</span>
                                <span>${translateText('admin.profiles.fields.joined')}: ${formatDate(profile.created_at)}</span>
                            </div>
                            <div class="contact-links">
                                ${getWhatsAppLink(profile)}
                                <span class="email-link" data-user-id="${profile.user_id}"></span>
                            </div>
                        </div>
                        <div class="profile-actions">
                            ${getApprovalStatus(profile.admin_approved)}
                            <button class="btn btn-secondary btn-sm" onclick="viewProfile('${profile.id}')">
                                <i class="fas fa-eye"></i>
                                ${translateText('admin.profiles.actions.view')}
                            </button>
                        </div>
                    </div>
                    
                    

                    <div class="profile-actions" style="margin-top: 16px; gap: 8px;">
                        <button class="btn btn-primary btn-sm" onclick="approveProfile('${profile.id}')">
                            <i class="fas fa-check"></i>
                            ${translateText('admin.profiles.actions.approve')}
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="rejectProfile('${profile.id}')">
                            <i class="fas fa-times"></i>
                            ${translateText('admin.profiles.actions.reject')}
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="viewMedia('${profile.id}')">
                            <i class="fas fa-images"></i>
                            ${translateText('admin.profiles.actions.view_media')}
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteProfile('${profile.id}')">
                            <i class="fas fa-trash"></i>
                            ${translateText('admin.profiles.actions.delete')}
                        </button>
                    </div>
                </div>
            `).join('');

            // Fill async email placeholders
            if (window.fillEmailsForElements) window.fillEmailsForElements(container);

            // Update count and render pagination
            const countEl = document.getElementById('profilesCount');
            if (countEl) countEl.textContent = `(${filteredProfiles.length})`;
            renderPagination(totalPages);
        }

        function renderPagination(totalPages) {
            const container = document.getElementById('paginationContainer');
            
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            const pagination = createPagination(currentPage, totalPages, (page) => {
                currentPage = page;
                renderProfiles();
            });

            container.innerHTML = '';
            container.appendChild(pagination);
        }

        function getInitials(firstName, lastName) {
            const first = firstName ? firstName.charAt(0).toUpperCase() : '';
            const last = lastName ? lastName.charAt(0).toUpperCase() : '';
            return first + last || '?';
        }

        function getApprovalStatus(status) {
            if (status === true) {
                return `<span class="approval-status approved"><i class="fas fa-check"></i> ${translateText('admin.profiles.status.approved')}</span>`;
            } else if (status === false) {
                return `<span class="approval-status rejected"><i class="fas fa-times"></i> ${translateText('admin.profiles.status.rejected')}</span>`;
            } else {
                return `<span class="approval-status pending"><i class="fas fa-clock"></i> ${translateText('admin.profiles.status.pending')}</span>`;
            }
        }

        function digitsOnly(value) {
            return (value || '').toString().replace(/\D/g, '');
        }

        function formatE164(phoneCode, mobileNumber) {
            const country = digitsOnly(phoneCode);
            let msisdn = digitsOnly(mobileNumber);
            if (!msisdn && !country) return null;
            if (country) {
                if (msisdn.startsWith('00' + country)) {
                    msisdn = msisdn.slice(('00' + country).length);
                }
                if (msisdn.startsWith(country)) {
                    // already full
                    return { display: '+' + msisdn, dial: msisdn };
                }
                // drop leading zeros for local numbers like 0503...
                msisdn = msisdn.replace(/^0+/, '');
                const full = country + msisdn;
                return { display: '+' + full, dial: full };
            }
            // No country code provided
            if (msisdn.startsWith('00')) msisdn = msisdn.slice(2);
            return { display: '+' + msisdn, dial: msisdn };
        }

        function getWhatsAppLink(profile) {
            const fmt = formatE164(profile.phone_code, profile.mobile_number);
            if (!fmt || !fmt.dial) return '';
            const url = `https://wa.me/${fmt.dial}`;
            return `<a href="${url}" target="_blank" rel="noopener"><i class=\"fab fa-whatsapp\"></i> ${fmt.display}</a>`;
        }

        function getEmailLink(profile) {
            const email = profile.email || '';
            if (!email) return '';
            return `<a href="mailto:${email}"><i class="fas fa-envelope"></i> ${email}</a>`;
        }

        function truncateText(text, maxLength) {
            if (!text || text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        function calculateAge(dateOfBirth) {
            if (!dateOfBirth) return null;
            const today = new Date();
            const birthDate = new Date(dateOfBirth);
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }

        function openAvatarFullscreen(url, alt, mediaType = 'photo') {
            const overlay = document.createElement('div');
            overlay.className = 'fullscreen-media-overlay';
            
            // Determine if it's a video based on URL or mediaType
            const isVideo = mediaType === 'Video' || mediaType === 'video' || 
                           url.includes('.mp4') || url.includes('.mov') || url.includes('.webm') || url.includes('.avi');
            
            overlay.innerHTML = `
                <div class="fullscreen-media-container">
                    <div class="fullscreen-header">
                        <button class="fullscreen-close" onclick="this.closest('.fullscreen-media-overlay').remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="fullscreen-content">
                        ${isVideo ? `
                            <video controls autoplay preload="metadata" class="fullscreen-video">
                                <source src="${url}" type="video/mp4">
                                <source src="${url}" type="video/webm">
                                <source src="${url}" type="video/mov">
                                Your browser does not support the video tag.
                            </video>
                        ` : `
                            <img src="${url}" alt="${alt}" class="fullscreen-image">
                        `}
                    </div>
                    <div class="fullscreen-footer">
                        <span class="media-info">${alt}</span>
                    </div>
                </div>
            `;
            
            overlay.onclick = function(e) {
                if (e.target === overlay || e.target.classList.contains('fullscreen-media-container')) {
                    // Pause video if it's playing
                    const video = overlay.querySelector('video');
                    if (video) video.pause();
                    overlay.remove();
                }
            };
            
            // Handle escape key
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    const video = overlay.querySelector('video');
                    if (video) video.pause();
                    overlay.remove();
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);
            
            document.body.appendChild(overlay);
            
            // Focus on the overlay for keyboard navigation
            overlay.focus();
        }

        async function approveProfile(profileId) {
            try {
                // Always use real data
                
                // Real mode
                const { data, error } = await window.supabaseClient
                    .from('user_profiles')
                    .update({ admin_approved: true })
                    .eq('id', profileId)
                    .select('id, admin_approved');

                if (error) {
                    if (error.code === 'PGRST301' || error.message?.toLowerCase().includes('jwt') || error.message?.toLowerCase().includes('auth')) {
                        if (window.handleAuthIssue) return window.handleAuthIssue();
                    }
                    throw error;
                }
                if (!data || data.length === 0 || data[0].admin_approved !== true) {
                    showNotification('No rows updated. Check RLS or session.', 'error');
                    return;
                }

                showNotification('Profile approved successfully', 'success');
                // Update in-memory profile to avoid full reload
                const idx = profiles.findIndex(p => p.id === profileId);
                if (idx !== -1) {
                    profiles[idx].admin_approved = true;
                }
                applyFilters();
            } catch (error) {
                console.error('Error approving profile:', error);
                showNotification('Error approving profile', 'error');
            }
        }

        async function rejectProfile(profileId) {
            try {
                // Always use real data
                
                // Real mode
                const { data, error } = await window.supabaseClient
                    .from('user_profiles')
                    .update({ admin_approved: false })
                    .eq('id', profileId)
                    .select('id, admin_approved');

                if (error) throw error;
                if (!data || data.length === 0 || data[0].admin_approved !== false) {
                    showNotification('No rows updated. Check RLS or session.', 'error');
                    return;
                }

                showNotification('Profile rejected', 'success');
                const idx = profiles.findIndex(p => p.id === profileId);
                if (idx !== -1) {
                    profiles[idx].admin_approved = false;
                }
                applyFilters();
            } catch (error) {
                console.error('Error rejecting profile:', error);
                showNotification('Error rejecting profile', 'error');
            }
        }

        function deleteProfile(profileId) {
            confirmAction(
                'Are you sure you want to delete this profile and all associated media? This action cannot be undone.',
                async () => {
                    try {
                        // 1) Get user_id for this profile
                        const { data: profileRow, error: profileErr } = await window.supabaseClient
                            .from('user_profiles')
                            .select('user_id')
                            .eq('id', profileId)
                            .single();
                        if (profileErr) throw profileErr;
                        const userId = profileRow?.user_id;

                        // 2) Get all media for this user
                        const { data: mediaList, error: mediaErr } = await window.supabaseClient
                            .from('media_references')
                            .select('id')
                            .eq('user_id', userId);
                        if (mediaErr) throw mediaErr;

                        // 3) Delete all media (storage + DB) using admin function
                        if (mediaList && mediaList.length > 0) {
                            showNotification(`Deleting ${mediaList.length} media files...`, 'info');
                            
                            for (const media of mediaList) {
                                try {
                                    const resp = await window.supabaseClient.functions.invoke('admin-delete-media', { 
                                        body: { mediaId: media.id } 
                                    });
                                    if (resp?.error) {
                                        console.warn(`Failed to delete media ${media.id}:`, resp.error);
                                    } else {
                                        const payload = resp?.data || {};
                                        if (!payload.success) {
                                            console.warn(`Failed to delete media ${media.id}:`, payload.error);
                                        }
                                    }
                                } catch (e) {
                                    console.warn(`Error deleting media ${media.id}:`, e);
                                }
                            }
                        }

                        // 4) Delete profile row via RPC to bypass RLS issues safely
                        const { error: delErr } = await window.supabaseClient
                            .rpc('admin_delete_user_profile', { in_profile_id: profileId });
                        if (delErr) throw delErr;

                        showNotification('Profile and all media deleted successfully', 'success');
                        loadProfiles();
                    } catch (error) {
                        console.error('Error deleting profile:', error);
                        showNotification('Error deleting profile', 'error');
                    }
                }
            );
        }

        // Helpers to translate option values similar to matchdetails.tsx
        function normalizeEnumValue(value) {
            if (!value) return '';
            return String(value).trim().toLowerCase().replace(/[^a-z0-9]+/g, '_');
        }

        function formatEnumValue(value) {
            if (!value) return '';
            const s = String(value).replace(/_/g, ' ').trim();
            return s.charAt(0).toUpperCase() + s.slice(1);
        }

        // Synonyms to map display strings to canonical keys used in translation tables
        const optionSynonyms = {
            education: {
                bachelor_s_degree: 'bachelor',
                bachelors_degree: 'bachelor',
                master_s_degree: 'master',
                masters_degree: 'master',
                phd_doctorate: 'phd'
            },
            living: {
                living_with_parents: 'with_parents',
                living_with_children: 'with_children',
                living_alone: 'alone'
            }
        };

        function translateOption(category, value) {
            if (!value) return translateText('admin.common.not_specified');
            let key = normalizeEnumValue(value);
            if (optionSynonyms[category] && optionSynonyms[category][key]) {
                key = optionSynonyms[category][key];
            }
            const path = `admin.profile_options.${category}.${key}`;
            const translated = translateText(path);
            return translated === path ? formatEnumValue(value) : translated;
        }

        function translateLanguages(langs) {
            if (!langs) return translateText('admin.common.not_specified');
            if (Array.isArray(langs) && langs.length > 0) {
                return langs.map(l => translateOption('languages', l)).join(', ');
            }
            return translateOption('languages', langs);
        }

        async function viewProfile(profileId) {
            try {
                const { data: p, error } = await window.supabaseClient
                    .from('user_profiles')
                    .select(`
                        id, user_id, first_name, last_name, gender, date_of_birth,
                        country, city, height_cm, weight_kg, eye_color, hair_color, skin_tone, body_type,
                        education_level, occupation, work_status,
                        housing_type, living_condition,
                        phone_code, mobile_number, languages_spoken,
                        profile_picture_url, about_me, is_public, admin_approved,
                        created_at, updated_at
                    `)
                    .eq('id', profileId)
                    .single();
                if (error || !p) {
                    showNotification('Failed to load profile details', 'error');
                    return;
                }

                const languages = translateLanguages(p.languages_spoken);
                const ageVal = calculateAge(p.date_of_birth);

                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3><a href="/matchdetails?userId=${p.user_id}" target="_blank" rel="noopener">${p.first_name} ${p.last_name}</a></h3>
                                <button class="close-btn" onclick="this.closest('.modal-overlay').remove()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div class="profile-sections">
                                    <div class="profile-section">
                                        <h4>${translateText('admin.profiles.modal.sections.personal_information')}</h4>
                                        <div class="info-grid">
                                            <div class="info-item"><label>${translateText('admin.profiles.modal.labels.age')}:</label><span>${typeof ageVal === 'number' ? ageVal : 'N/A'}</span></div>
                                            <div class="info-item"><label>${translateText('admin.profiles.modal.labels.gender')}:</label><span>${p.gender ? translateOption('gender', p.gender) : translateText('admin.common.not_specified')}</span></div>
                                            <div class="info-item"><label>${translateText('admin.profiles.modal.labels.country')}:</label><span>${p.country || translateText('admin.common.not_specified')}</span></div>
                                            <div class="info-item"><label>${translateText('admin.profiles.modal.labels.city')}:</label><span>${p.city || translateText('admin.common.not_specified')}</span></div>
                                            <div class="info-item"><label>${translateText('admin.profiles.modal.labels.height')}:</label><span>${p.height_cm ? (p.height_cm + ' ' + translateText('admin.common.cm')) : translateText('admin.common.not_specified')}</span></div>
                                            <div class="info-item"><label>${translateText('admin.profiles.modal.labels.weight')}:</label><span>${p.weight_kg ? (p.weight_kg + ' ' + translateText('admin.common.kg')) : translateText('admin.common.not_specified')}</span></div>
                                            <div class="info-item"><label>${translateText('admin.profiles.modal.labels.eye_color')}:</label><span>${p.eye_color ? translateOption('eye_color', p.eye_color) : translateText('admin.common.not_specified')}</span></div>
                                            <div class="info-item"><label>${translateText('admin.profiles.modal.labels.hair_color')}:</label><span>${p.hair_color ? translateOption('hair_color', p.hair_color) : translateText('admin.common.not_specified')}</span></div>
                                            <div class="info-item"><label>${translateText('admin.profiles.modal.labels.skin_tone')}:</label><span>${p.skin_tone ? translateOption('skin_tone', p.skin_tone) : translateText('admin.common.not_specified')}</span></div>
                                            <div class="info-item"><label>${translateText('admin.profiles.modal.labels.body_type')}:</label><span>${p.body_type ? translateOption('body_type', p.body_type) : translateText('admin.common.not_specified')}</span></div>
                                        </div>
                                    </div>

                                    <div class="profile-section">
                                        <h4>${translateText('admin.profiles.modal.sections.education_work')}</h4>
                                        <div class="info-grid">
                                            <div class="info-item"><label>${translateText('admin.profiles.modal.labels.education')}:</label><span>${p.education_level ? translateOption('education', p.education_level) : translateText('admin.common.not_specified')}</span></div>
                                            <div class="info-item"><label>${translateText('admin.profiles.modal.labels.occupation')}:</label><span>${p.occupation || translateText('admin.common.not_specified')}</span></div>
                                            <div class="info-item"><label>${translateText('admin.profiles.modal.labels.work_status')}:</label><span>${p.work_status ? translateOption('work_status', p.work_status) : translateText('admin.common.not_specified')}</span></div>
                                        </div>
                                    </div>

                                    <div class="profile-section">
                                        <h4>${translateText('admin.profiles.modal.sections.living_situation')}</h4>
                                        <div class="info-grid">
                                            <div class="info-item"><label>${translateText('admin.profiles.modal.labels.housing')}:</label><span>${p.housing_type ? translateOption('housing', p.housing_type) : translateText('admin.common.not_specified')}</span></div>
                                            <div class="info-item"><label>${translateText('admin.profiles.modal.labels.living_condition')}:</label><span>${p.living_condition ? translateOption('living', p.living_condition) : translateText('admin.common.not_specified')}</span></div>
                                        </div>
                                    </div>

                                    <div class="profile-section">
                                        <h4>${translateText('admin.profiles.modal.sections.contact_languages')}</h4>
                                        <div class="info-grid">
                                            <div class="info-item"><label>${translateText('admin.profiles.modal.labels.phone')}:</label><span>${((p.phone_code || '') + (p.mobile_number || '')).trim() || translateText('admin.common.not_specified')}</span></div>
                                            <div class="info-item"><label>${translateText('admin.profiles.modal.labels.languages')}:</label><span>${languages}</span></div>
                                        </div>
                                    </div>

                                    <div class="profile-section">
                                        <h4>${translateText('admin.profiles.modal.sections.about')}</h4>
                                        <p>${p.about_me || translateText('admin.common.not_specified')}</p>
                                    </div>

                                    <div class="profile-section">
                                        <h4>${translateText('admin.profiles.modal.sections.account_info')}</h4>
                                        <div class="info-grid">
                                            <div class="info-item"><label>${translateText('admin.profiles.modal.labels.public_profile')}:</label><span>${p.is_public ? translateText('admin.common.yes') : translateText('admin.common.no')}</span></div>
                                            <div class="info-item"><label>${translateText('admin.profiles.modal.labels.approval')}:</label><span>${p.admin_approved === true ? translateText('admin.profiles.status.approved') : (p.admin_approved === false ? translateText('admin.profiles.status.rejected') : translateText('admin.profiles.status.pending'))}</span></div>
                                            <div class="info-item"><label>${translateText('admin.profiles.modal.labels.joined')}:</label><span>${formatDateTime(p.created_at)}</span></div>
                                            <div class="info-item"><label>${translateText('admin.profiles.modal.labels.last_updated')}:</label><span>${formatDateTime(p.updated_at)}</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                ${p.admin_approved === null ? `
                                    <button class="btn btn-primary" onclick="approveProfile('${p.id}'); this.closest('.modal-overlay').remove();">
                                        <i class="fas fa-check"></i>
                                        ${translateText('admin.profiles.actions.approve')}
                                    </button>
                                    <button class="btn btn-danger" onclick="rejectProfile('${p.id}'); this.closest('.modal-overlay').remove();">
                                        <i class="fas fa-times"></i>
                                        ${translateText('admin.profiles.actions.reject')}
                                    </button>
                                ` : ''}
                                <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">${translateText('admin.profiles.modal.buttons.close')}</button>
                            </div>
                        </div>
                    </div>`;
                document.body.appendChild(modal);
            } catch (e) {
                console.error('View profile error:', e);
                showNotification('Failed to load profile details', 'error');
            }
        }

        async function viewMedia(profileId) {
            try {
                const profile = profiles.find(p => p.id === profileId);
                if (!profile || !profile.user_id) {
                    showNotification('User not found for this profile', 'error');
                    return;
                }
                let photos = [];
                let videos = [];
                const { data: mediaRows, error } = await window.supabaseClient
                    .from('media_references')
                    .select('id, media_type, external_url, thumbnail_url, upload_date, created_at')
                    .eq('user_id', profile.user_id)
                    .order('upload_date', { ascending: false })
                    .order('created_at', { ascending: false });
                if (!error && mediaRows) {
                    photos = mediaRows.filter(m => m.media_type === 'photo');
                    videos = mediaRows.filter(m => m.media_type === 'video');
                }

                // Build modal
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>Media Library</h3>
                                <button class="close-btn" onclick="this.closest('.modal-overlay').remove()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div class="tabs">
                                    <button class="tab-btn active" data-tab="photos" onclick="switchMediaTab(this, 'photos')"><i class="fas fa-image"></i> Photos (${photos.length})</button>
                                    <button class="tab-btn" data-tab="videos" onclick="switchMediaTab(this, 'videos')"><i class="fas fa-video"></i> Videos (${videos.length})</button>
                                </div>
                                <div id="media-photos" class="media-grid">
                                    ${photos.map(p => `
                                        <div class="media-card">
                                            <img src="${p.external_url}" alt="Photo" onclick="openAvatarFullscreen('${p.external_url}','Photo', 'photo')" loading="lazy" />
                                            <button class="media-delete" onclick="deleteMedia('${p.id}', '${profileId}')"><i class="fas fa-trash"></i></button>
                                        </div>
                                    `).join('')}
                                </div>
                                <div id="media-videos" class="media-grid" style="display:none;">
                                    ${videos.map(v => `
                                        <div class="media-card">
                                            <img src="${v.thumbnail_url || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjZjNmNGY2Ii8+Cjxwb2x5Z29uIHBvaW50cz0iNzUsNjAgMTI1LDEwMCA3NSwxNDAiIGZpbGw9IiM2YjczODAiLz4KPC9zdmc+'}" 
                                                 alt="Video thumbnail" 
                                                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjZjNmNGY2Ii8+Cjxwb2x5Z29uIHBvaW50cz0iNzUsNjAgMTI1LDEwMCA3NSwxNDAiIGZpbGw9IiM2YjczODAiLz4KPC9zdmc+'" 
                                                 onclick="openAvatarFullscreen('${v.external_url}','Video', 'video')" 
                                                 loading="lazy" />
                                            <div class="play-badge"><i class="fas fa-play"></i></div>
                                            <button class="media-delete" onclick="deleteMedia('${v.id}', '${profileId}')"><i class="fas fa-trash"></i></button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Close</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (e) {
                console.error('Media modal error:', e);
                showNotification('Failed to load media', 'error');
            }
        }

        function switchMediaTab(buttonEl, tab) {
            const container = buttonEl.closest('.modal-content');
            container.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            buttonEl.classList.add('active');
            container.querySelector('#media-photos').style.display = tab === 'photos' ? 'grid' : 'none';
            container.querySelector('#media-videos').style.display = tab === 'videos' ? 'grid' : 'none';
        }

        async function deleteMedia(mediaId, profileId) {
            confirmAction('Delete this media?', async () => {
                try {
                    // Delete from storage and DB using admin function
                    const resp = await window.supabaseClient.functions.invoke('admin-delete-media', { 
                        body: { mediaId } 
                    });
                    if (resp?.error) throw resp.error;
                    const payload = resp?.data || {};
                    if (!payload.success) {
                        throw new Error(payload.error || 'Delete failed');
                    }
                    // If any storage errors returned, log but continue since DB was deleted
                    if (Array.isArray(payload.errors) && payload.errors.length) {
                        console.warn('Storage delete partial errors:', payload.errors);
                    }
                    
                    showNotification('Media deleted', 'success');
                    // Refresh modal
                    document.querySelector('.modal-overlay').remove();
                    viewMedia(profileId);
                } catch (e) {
                    console.error('Delete media error:', e);
                    showNotification('Failed to delete media', 'error');
                }
            });
        }

        // Removed grid/list toggle; list view enforced

        const handleSearch = debounce(() => {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            applyFilters();
        }, 300);

        function handleFilter() {
            applyFilters();
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const approvalFilter = document.getElementById('approvalFilter').value;
            const ageFilter = document.getElementById('ageFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            const countryFilter = document.getElementById('countryFilter').value;

            filteredProfiles = profiles.filter(profile => {
                // Search filter
                const email = (window.getCachedEmailForUser && window.getCachedEmailForUser(profile.user_id)) ? window.getCachedEmailForUser(profile.user_id).toLowerCase() : '';
                const combinedName = `${(profile.first_name||'').toLowerCase()} ${(profile.last_name||'').toLowerCase()}`.trim();
                const ageVal = calculateAge(profile.date_of_birth);
                const ageStr = typeof ageVal === 'number' ? String(ageVal) : '';
                const phone = `${profile.phone_code||''}${profile.mobile_number||''}`.toLowerCase();
                const matchesSearch = !searchTerm ||
                    combinedName.includes(searchTerm) ||
                    ageStr.includes(searchTerm) ||
                    (profile.country||'').toLowerCase().includes(searchTerm) ||
                    (profile.city||'').toLowerCase().includes(searchTerm) ||
                    phone.includes(searchTerm) ||
                    email.includes(searchTerm);

                // Approval filter
                let matchesApproval = true;
                if (approvalFilter === 'approved') {
                    matchesApproval = profile.admin_approved === true;
                } else if (approvalFilter === 'rejected') {
                    matchesApproval = profile.admin_approved === false;
                } else if (approvalFilter === 'pending') {
                    matchesApproval = profile.admin_approved === null;
                }

                // Age filter
                let matchesAge = true;
                if (ageFilter && profile.age) {
                    const age = parseInt(profile.age);
                    switch (ageFilter) {
                        case '18-25':
                            matchesAge = age >= 18 && age <= 25;
                            break;
                        case '26-35':
                            matchesAge = age >= 26 && age <= 35;
                            break;
                        case '36-45':
                            matchesAge = age >= 36 && age <= 45;
                            break;
                        case '46+':
                            matchesAge = age >= 46;
                            break;
                    }
                }

                // Country filter
                let matchesCountry = true;
                if (countryFilter) {
                    matchesCountry = (profile.country||'') === countryFilter;
                }

                // Date filter
                let matchesDate = true;
                if (dateFilter) {
                    const profileDate = new Date(profile.created_at);
                    const now = new Date();
                    
                    switch (dateFilter) {
                        case 'today':
                            matchesDate = profileDate.toDateString() === now.toDateString();
                            break;
                        case 'week':
                            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                            matchesDate = profileDate >= weekAgo;
                            break;
                        case 'month':
                            const monthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
                            matchesDate = profileDate >= monthAgo;
                            break;
                        case 'year':
                            const yearAgo = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
                            matchesDate = profileDate >= yearAgo;
                            break;
                    }
                }

                return matchesSearch && matchesApproval && matchesAge && matchesCountry && matchesDate;
            });

            currentPage = 1;
            renderProfiles();
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('approvalFilter').value = '';
            document.getElementById('ageFilter').value = '';
            document.getElementById('dateFilter').value = '';
            document.getElementById('countryFilter').value = '';
            
            filteredProfiles = [...profiles];
            currentPage = 1;
            renderProfiles();
        }

        function populateCountryOptions() {
            try {
                const select = document.getElementById('countryFilter');
                if (!select) return;
                const set = new Set((profiles||[]).map(p => (p.country||'')).filter(Boolean));
                const sorted = Array.from(set).sort((a,b)=>a.localeCompare(b));
                // Clear previous options except first
                while (select.options.length > 1) select.remove(1);
                for (const c of sorted) {
                    const opt = document.createElement('option');
                    opt.value = c;
                    opt.textContent = c;
                    select.appendChild(opt);
                }
            } catch {}
        }

        function exportProfiles() {
            if (filteredProfiles.length === 0) {
                showNotification('No profiles to export', 'warning');
                return;
            }

            const exportData = filteredProfiles.map(profile => ({
                'First Name': profile.first_name,
                'Last Name': profile.last_name,
                'Email': profile.email,
                'Age': profile.age || '',
                'Location': profile.location || '',
                'Bio': profile.bio || '',
                'Approval Status': profile.admin_approved === true ? 'Approved' : 
                                  profile.admin_approved === false ? 'Rejected' : 'Pending',
                'Joined Date': formatDate(profile.created_at),
                'Last Updated': formatDate(profile.updated_at)
            }));

            exportToCSV(exportData, `female-profiles-${new Date().toISOString().split('T')[0]}.csv`);
        }
    </script>
</body>
</html>
