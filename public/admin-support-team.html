<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Support Team</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="admin-translations.js"></script>
    <link rel="stylesheet" href="admin-styles.css">
    <style>
        .table-actions-inline select {
            padding: 4px 8px;
            font-size: 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: #fff;
        }
        .status-badge { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:600; }
        .status-active { background:#dcfce7; color:#16a34a; }
        .status-inactive { background:#fee2e2; color:#dc2626; }
        .email-cell .email-link { white-space:nowrap; }
        .user-name { font-weight:600; color:#1f2937; }
        .user-meta { color:#6b7280; font-size:12px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
        .role-badge { 
            display:inline-block; 
            padding:4px 12px; 
            border-radius:16px; 
            font-size:11px; 
            font-weight:600; 
            background:#f3f4f6; 
            color:#374151;
        }
        .edit-input {
            padding: 6px 8px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        .edit-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
    </style>
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-shield-alt"></i>
                    <span>Zawajplus Admin</span>
                </div>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="/admin-dashboard.html" class="nav-link">
                        <i class="fas fa-tachometer-alt"></i>
                        <span data-translate="admin.navigation.dashboard">Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin-female-profiles.html" class="nav-link">
                        <i class="fas fa-female"></i>
                        <span data-translate="admin.navigation.female_profiles">Female Profiles</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin-male-profiles.html" class="nav-link">
                        <i class="fas fa-male"></i>
                        <span data-translate="admin.navigation.male_profiles">Male Profiles</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin-interests.html" class="nav-link">
                        <i class="fas fa-heart"></i>
                        <span data-translate="admin.navigation.interests">Interests</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin-meet-requests.html" class="nav-link">
                        <i class="fas fa-video"></i>
                        <span data-translate="admin.navigation.meet_requests">Meet Requests</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin-whatsapp-requests.html" class="nav-link">
                        <i class="fab fa-whatsapp"></i>
                        <span data-translate="admin.navigation.whatsapp_requests">WhatsApp Requests</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin-packages.html" class="nav-link">
                        <i class="fas fa-box"></i>
                        <span data-translate="admin.navigation.packages">Packages</span>
                    </a>
                </li>
                <li class="nav-item active">
                    <a href="/admin-support-team.html" class="nav-link">
                        <i class="fas fa-headset"></i>
                        <span data-translate="admin.navigation.support_team">Support Team</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin-management.html" class="nav-link">
                        <i class="fas fa-user-cog"></i>
                        <span data-translate="admin.navigation.admin_management">Admin Management</span>
                    </a>
                </li>
            </ul>

            <!-- Language Selector in Sidebar -->
            <div class="sidebar-language-selector">
                <div class="language-dropdown">
                    <button type="button" class="language-btn" onclick="toggleLanguageMenu()">
                        <span id="currentLanguage">English</span>
                        <i class="fas fa-chevron-down" style="font-size: 10px;"></i>
                    </button>
                    <div class="language-menu" id="languageMenu">
                        <div class="language-option active" data-lang="en" onclick="changeLanguage('en')">
                            <span>English</span>
                        </div>
                        <div class="language-option" data-lang="ar" onclick="changeLanguage('ar')">
                            <span>العربية</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sidebar-footer">
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span data-translate="admin.navigation.logout">Logout</span>
                </button>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <header class="top-bar">
                <div class="top-bar-left">
                    <button class="sidebar-toggle" onclick="toggleSidebar()">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title" data-translate="admin.support_team.title">Support Team</h1>
                </div>
                <div class="top-bar-right">
                    <div class="admin-info">
                        <div class="admin-details">
                            <span class="admin-name" id="adminName" data-translate="admin.common.loading">Loading...</span>
                            <span class="admin-role" id="adminRole">Admin</span>
                        </div>
                        <div class="admin-avatar">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <button onclick="logout()" title="Logout" style="background:none;border:none;color:#6b7280;font-size:18px;cursor:pointer;margin-left:8px;display:flex;align-items:center;" aria-label="Logout">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </header>

            <div class="content-area">
                <div class="data-table">
                    <div class="table-header">
                        <div class="table-title"><span data-translate="admin.support_team.title">Support Team</span> <span id="recordsCount"></span></div>
                        <div class="table-actions">
                            <button class="btn btn-secondary btn-sm" onclick="loadSupportTeam()"><i class="fas fa-sync-alt"></i> <span data-translate="admin.support_team.buttons.refresh">Refresh</span></button>
                        </div>
                    </div>
                    <div style="overflow-x:auto;">
                        <table class="table" id="supportTeamTable">
                            <thead>
                                <tr>
                                    <th data-translate="admin.support_team.table.role">Role</th>
                                    <th data-translate="admin.support_team.table.name">Name</th>
                                    <th data-translate="admin.support_team.table.mobile">Mobile Number</th>
                                    <th data-translate="admin.support_team.table.email">Email</th>
                                    <th data-translate="admin.support_team.table.actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="supportTbody">
                                <tr><td colspan="5" data-translate="admin.common.loading">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="admin-common.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            loadAdminInfo();
            loadSupportTeam();
        });

        async function loadSupportTeam(){
            const tbody = document.getElementById('supportTbody');
            if (!tbody) return;
            tbody.innerHTML = `<tr><td colspan="5">${translateText('admin.common.loading')}</td></tr>`;
            try {
                const { data, error } = await window.supabaseClient
                    .from('support_team')
                    .select('id, name, role, whatsapp_number, email, is_active')
                    .order('role');
                if (error) throw error;
                const rows = Array.isArray(data) ? data : [];
                if (rows.length === 0){
                    tbody.innerHTML = `<tr><td colspan="5">${translateText('admin.common.no_data')}</td></tr>`;
                    document.getElementById('recordsCount').textContent = '(0)';
                    return;
                }
                tbody.innerHTML = rows.map(r => {
                    const whatsappFormatted = formatPhone('', r.whatsapp_number);
                    return `
                        <tr data-id="${r.id}">
                            <td><span class="role-badge">${escapeHtml(r.role || '')}</span></td>
                            <td class="email-cell">
                                <div class="user-name">
                                    <span class="view" data-field="name">${escapeHtml(r.name || '')}</span>
                                    <input class="edit-input" data-field="name" type="text" value="${escapeAttr(r.name||'')}" style="display:none; width: 100%;" />
                                </div>
                            </td>
                            <td>
                                <div class="user-meta">
                                    <span class="view" data-field="whatsapp_number">${whatsappFormatted ? `<a href="https://wa.me/${whatsappFormatted.replace(/\\+/g,'')}" target="_blank">${whatsappFormatted}</a>` : '-'}</span>
                                    <input class="edit-input" data-field="whatsapp_number" type="text" value="${escapeAttr(r.whatsapp_number||'')}" style="display:none; width: 100%;" />
                                </div>
                            </td>
                            <td class="email-cell">
                                <span class="view email-link" data-field="email">${r.email ? `<a href="mailto:${escapeHtml(r.email)}">${escapeHtml(r.email)}</a>` : '-'}</span>
                                <input class="edit-input" data-field="email" type="email" value="${escapeAttr(r.email||'')}" style="display:none; width: 100%;" />
                            </td>
                            <td>
                                <button class="btn btn-secondary btn-sm" onclick="enterEditMode('${r.id}')"><i class="fas fa-pen"></i> ${translateText('admin.support_team.actions.edit')}</button>
                                <button class="btn btn-primary btn-sm" data-action="save" data-id="${r.id}" style="display:none;" onclick="saveRow('${r.id}')"><i class="fas fa-save"></i> ${translateText('admin.common.save')}</button>
                                <button class="btn btn-secondary btn-sm" data-action="cancel" data-id="${r.id}" style="display:none;" onclick="cancelEdit('${r.id}')"><i class="fas fa-times"></i> ${translateText('admin.common.cancel')}</button>
                            </td>
                        </tr>
                    `;
                }).join('');
                document.getElementById('recordsCount').textContent = `(${rows.length})`;
            } catch (e) {
                console.error('Load support team error', e);
                tbody.innerHTML = `<tr><td colspan="5">${translateText('admin.common.error')}</td></tr>`;
            }
        }

        function escapeHtml(str){
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }
        function escapeAttr(str){
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/"/g, '&quot;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
        }

        function digitsOnly(v){ return (v||'').toString().replace(/\D/g,''); }
        function formatPhone(code, number){
            const c = digitsOnly(code); let n = digitsOnly(number);
            if (!c && !n) return '';
            if (c){ n = n.replace(/^0+/, ''); return `+${c}${n}`; }
            if (n.startsWith('00')) n = n.slice(2); return `+${n}`;
        }

        function enterEditMode(id){
            const tr = document.querySelector(`tr[data-id="${id}"]`);
            if (!tr) return;
            tr.querySelectorAll('.view').forEach(el => (el).style.display = 'none');
            tr.querySelectorAll('.edit-input').forEach(el => (el).style.display = 'block');
            const saveBtn = tr.querySelector('button[data-action="save"]');
            const cancelBtn = tr.querySelector('button[data-action="cancel"]');
            if (saveBtn) saveBtn.style.display = 'inline-flex';
            if (cancelBtn) cancelBtn.style.display = 'inline-flex';
        }

        function cancelEdit(id){
            const tr = document.querySelector(`tr[data-id="${id}"]`);
            if (!tr) return;
            tr.querySelectorAll('.view').forEach(el => (el).style.display = '');
            tr.querySelectorAll('.edit-input').forEach(el => (el).style.display = 'none');
            const saveBtn = tr.querySelector('button[data-action="save"]');
            const cancelBtn = tr.querySelector('button[data-action="cancel"]');
            if (saveBtn) saveBtn.style.display = 'none';
            if (cancelBtn) cancelBtn.style.display = 'none';
        }

        async function saveRow(id){
            const tr = document.querySelector(`tr[data-id="${id}"]`);
            if (!tr) return;
            const name = (tr.querySelector('input.edit-input[data-field="name"]')||{}).value || '';
            const whatsapp_number = (tr.querySelector('input.edit-input[data-field="whatsapp_number"]')||{}).value || '';
            const email = (tr.querySelector('input.edit-input[data-field="email"]')||{}).value || '';
            try{
                const { error } = await window.supabaseClient
                    .from('support_team')
                    .update({ name, whatsapp_number, email })
                    .eq('id', id);
                if (error) throw error;
                showNotification('Saved', 'success');
                await loadSupportTeam();
            }catch(e){
                console.error('Save support row error', e);
                showNotification('Failed to save', 'error');
            }
        }
    </script>
</body>
</html>


