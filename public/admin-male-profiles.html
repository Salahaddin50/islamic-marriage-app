<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Male Profiles - Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="admin-styles.css">
    <style>
        .profile-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            margin-bottom: 16px;
        }

        /* Package-based accents */
        .profile-card.package-free { border-left: 4px solid #9ca3af; }
        .profile-card.package-premium { border-left: 4px solid #60a5fa; background: linear-gradient(0deg, rgba(96,165,250,0.06), rgba(96,165,250,0.06)), #ffffff; }
        .profile-card.package-vip { border-left: 4px solid #a78bfa; background: linear-gradient(0deg, rgba(167,139,250,0.06), rgba(167,139,250,0.06)), #ffffff; }
        .profile-card.package-golden { border-left: 4px solid #f59e0b; background: linear-gradient(0deg, rgba(245,158,11,0.06), rgba(245,158,11,0.06)), #ffffff; }

        .package-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 999px;
            margin-left: 8px;
        }
        .package-premium .package-badge { color:#1d4ed8; background:#dbeafe; }
        .package-vip .package-badge { color:#6d28d9; background:#ede9fe; }
        .package-golden .package-badge { color:#b45309; background:#fef3c7; }

        /* Package-based accents */
        .profile-card.package-free {
            border-left: 4px solid #9ca3af;
        }
        .profile-card.package-premium {
            border-left: 4px solid #60a5fa;
            background: linear-gradient(0deg, rgba(96,165,250,0.06), rgba(96,165,250,0.06)), #ffffff;
        }
        .profile-card.package-vip {
            border-left: 4px solid #a78bfa;
            background: linear-gradient(0deg, rgba(167,139,250,0.06), rgba(167,139,250,0.06)), #ffffff;
        }
        .profile-card.package-golden {
            border-left: 4px solid #f59e0b;
            background: linear-gradient(0deg, rgba(245,158,11,0.06), rgba(245,158,11,0.06)), #ffffff;
        }

        .package-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 999px;
        }
        .package-premium .package-badge { color:#1d4ed8; background:#dbeafe; }
        .package-vip .package-badge { color:#6d28d9; background:#ede9fe; }
        .package-golden .package-badge { color:#b45309; background:#fef3c7; }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ec4899, #be185d);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
            overflow: hidden;
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .profile-email {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .profile-meta {
            display: flex;
            gap: 16px;
            font-size: 12px;
            color: #9ca3af;
        }

        .profile-actions {
            display: flex;
            gap: 8px;
        }

        .profile-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .detail-label {
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .detail-value {
            font-size: 14px;
            color: #1f2937;
        }

        .approval-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .approval-status.approved {
            background: #dcfce7;
            color: #16a34a;
        }

        .approval-status.rejected {
            background: #fee2e2;
            color: #dc2626;
        }

        .approval-status.pending {
            background: #fef3c7;
            color: #d97706;
        }

        .media-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e5e7eb;
        }

        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .media-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .media-item img,
        .media-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .media-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .media-item:hover .media-overlay {
            opacity: 1;
        }

        .media-action {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .media-action:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .modal-dialog {
            background: white;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            color: #6b7280;
            cursor: pointer;
        }

        .view-mode-toggle {
            display: flex;
            background: #f3f4f6;
            border-radius: 8px;
            padding: 4px;
            gap: 4px;
        }

        .view-mode-btn {
            padding: 8px 12px;
            background: none;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            color: #6b7280;
            transition: all 0.2s ease;
        }

        .view-mode-btn.active {
            background: white;
            color: #1f2937;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .profiles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .profiles-list .profile-card {
            margin-bottom: 16px;
        }

        @media (max-width: 768px) {
            .profiles-grid {
                grid-template-columns: 1fr;
            }
            
            .profile-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .profile-actions {
                width: 100%;
                justify-content: stretch;
            }
            
            .profile-actions .btn {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-shield-alt"></i>
                    <span>Hume Admin</span>
                </div>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="/admin-dashboard.html" class="nav-link">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin-female-profiles.html" class="nav-link">
                        <i class="fas fa-female"></i>
                        <span>Female Profiles</span>
                    </a>
                </li>
                <li class="nav-item active">
                    <a href="/admin-male-profiles.html" class="nav-link">
                        <i class="fas fa-male"></i>
                        <span>Male Profiles</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin-interests.html" class="nav-link">
                        <i class="fas fa-tags"></i>
                        <span>Interests</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin-meet-requests.html" class="nav-link">
                        <i class="fas fa-video"></i>
                        <span>Meet Requests</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin-management.html" class="nav-link">
                        <i class="fas fa-user-cog"></i>
                        <span>Admin Management</span>
                    </a>
                </li>
            </ul>
            
            <div class="sidebar-footer">
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </button>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <header class="top-bar">
                <div class="top-bar-left">
                    <button class="sidebar-toggle" onclick="toggleSidebar()">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title">Male Profiles <span id="profilesCount">(0)</span></h1>
                </div>
                <div class="top-bar-right">
                    <div class="admin-info">
                        <div class="admin-details">
                            <span class="admin-name" id="adminName">Loading...</span>
                            <span class="admin-role" id="adminRole">Admin</span>
                        </div>
                        <div class="admin-avatar">
                            <i class="fas fa-user-circle"></i>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Filters -->
                <div class="filters-section">
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label class="filter-label">Search</label>
                            <input 
                                type="text" 
                                id="searchInput" 
                                class="filter-input" 
                                placeholder="Search by name, location, occupation..."
                                oninput="handleSearch()"
                            >
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Status</label>
                            <select id="approvalFilter" class="filter-select" onchange="handleFilter()">
                                <option value="">All</option>
                                <option value="approved">Approved</option>
                                <option value="rejected">Denied</option>
                                <option value="pending">Pending</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Joining Date</label>
                            <select id="dateFilter" class="filter-select" onchange="handleFilter()">
                                <option value="">All</option>
                                <option value="today">Today</option>
                                <option value="week">Last Week</option>
                                <option value="month">Last Month</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Package</label>
                            <select id="packageFilter" class="filter-select" onchange="handleFilter()">
                                <option value="">All</option>
                                <option value="free">Free</option>
                                <option value="premium">Premium</option>
                                <option value="vip">VIP Premium</option>
                                <option value="golden">Golden Premium</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Payment Status</label>
                            <select id="paymentFilter" class="filter-select" onchange="handleFilter()">
                                <option value="">All</option>
                                <option value="completed">Paid</option>
                                <option value="pending">Payment Pending</option>
                                <option value="failed">Payment Failed</option>
                                <option value="free">Free Account</option>
                            </select>
                        </div>
                    </div>
                    <div class="filters-actions">
                        <button class="btn btn-secondary" onclick="clearFilters()">
                            <i class="fas fa-times"></i>
                            Clear Filters
                        </button>
                        <button class="btn btn-primary" onclick="exportProfiles()">
                            <i class="fas fa-download"></i>
                            Export Data
                        </button>
                    </div>
                </div>

                <!-- Profiles Container -->
                <div id="profilesContainer" class="profiles-grid">
                    <div class="loading-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading male profiles...</p>
                    </div>
                </div>

                <!-- Pagination -->
                <div id="paginationContainer" style="margin-top: 24px;"></div>
            </div>
        </main>
    </div>

    <script src="admin-common.js"></script>
    <script>
        let profiles = [];
        let filteredProfiles = [];
        let currentPage = 1;
        let itemsPerPage = 12;
        let viewMode = 'list';

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadProfiles();
        });

        async function loadProfiles() {
            const container = document.getElementById('profilesContainer');
            showTableLoading(container, 'Loading male profiles...');

            // Always use real data

            try {
                const { data, error } = await window.supabaseClient
                    .from('user_profiles')
                    .select(`
                        id,
                        user_id,
                        first_name,
                        last_name,
                        gender,
                        date_of_birth,
                        country,
                        city,
                        height_cm,
                        weight_kg,
                        eye_color,
                        hair_color,
                        skin_tone,
                        body_type,
                        education_level,
                        occupation,
                        work_status,
                        housing_type,
                        living_condition,
                        phone_code,
                        mobile_number,
                        languages_spoken,
                        profile_picture_url,
                        about_me,
                        is_public,
                        admin_approved,
                        created_at,
                        updated_at
                    `)
                    .eq('gender', 'male')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                // Fetch latest payment record per user to derive package/status
                const userIds = (data || []).map(p => p.user_id).filter(Boolean);
                let paymentsByUser = {};
                if (userIds.length) {
                    const { data: paymentRows, error: paymentsError } = await window.supabaseClient
                        .from('payment_records')
                        .select('user_id, package_type, status, created_at')
                        .in('user_id', userIds)
                        .order('created_at', { ascending: false });
                    if (paymentsError) throw paymentsError;
                    for (const row of (paymentRows || [])) {
                        if (!paymentsByUser[row.user_id]) {
                            paymentsByUser[row.user_id] = row; // first row is latest due to sort desc
                        }
                    }
                }

                const merged = (data || []).map(p => ({
                    ...p,
                    package_type: paymentsByUser[p.user_id]?.package_type || 'free',
                    payment_status: paymentsByUser[p.user_id]?.status || 'free'
                }));

                profiles = merged;
                filteredProfiles = [...profiles];
                renderProfiles();

            } catch (error) {
                console.error('Error loading profiles:', error);
                showTableError(container, 'Error loading male profiles');
                
                // Fallback to mock data on error
                const mockProfiles = [
                    {
                        id: 'demo-f1',
                        first_name: 'Emma',
                        last_name: 'Johnson',
                        email: 'emma.j@example.com',
                        age: 28,
                        gender: 'female',
                        bio: 'Passionate about art, travel, and meeting new people. Love hiking and outdoor adventures.',
                        location: 'New York, NY',
                        admin_approved: true,
                        created_at: new Date(Date.now() - 5 * 24 * 3600000).toISOString(),
                        updated_at: new Date(Date.now() - 2 * 24 * 3600000).toISOString()
                    },
                    {
                        id: 'demo-f2',
                        first_name: 'Sophia',
                        last_name: 'Williams',
                        email: 'sophia.w@example.com',
                        age: 24,
                        gender: 'female',
                        bio: 'Medical student with a passion for helping others. Enjoy reading and quiet evenings.',
                        location: 'Boston, MA',
                        admin_approved: true,
                        created_at: new Date(Date.now() - 10 * 24 * 3600000).toISOString(),
                        updated_at: new Date(Date.now() - 8 * 24 * 3600000).toISOString()
                    }
                ];
                
                profiles = mockProfiles;
                filteredProfiles = [...profiles];
                renderProfiles();
            }
        }

        function renderProfiles() {
            const container = document.getElementById('profilesContainer');
            
            if (filteredProfiles.length === 0) {
                showTableEmpty(container, 'No male profiles found');
                return;
            }

            // Calculate pagination
            const totalPages = Math.ceil(filteredProfiles.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const currentProfiles = filteredProfiles.slice(startIndex, endIndex);

            // Force list view
            container.className = 'profiles-list';

            // Render profiles
            container.innerHTML = currentProfiles.map(profile => `
                <div class="profile-card ${getPackageClass(profile.package_type)}">
                    <div class="profile-header">
                        <div class="profile-avatar">
                            ${profile.profile_picture_url ? 
                                `<img src="${profile.profile_picture_url}" alt="${profile.first_name}"
                                      style="cursor:pointer;"
                                      onclick="openAvatarFullscreen('${profile.profile_picture_url}', '${profile.first_name} ${profile.last_name}')"
                                      onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                 <div class="avatar-fallback" style="display:none;">${getInitials(profile.first_name, profile.last_name)}</div>`
                                : getInitials(profile.first_name, profile.last_name)
                            }
                        </div>
                        <div class="profile-info">
                            <div class="profile-name">
                                ${profile.first_name} ${profile.last_name} ${getPackageCrown(profile.package_type)}
                            </div>
                            <div class="profile-email">${profile.phone_code || ''}${profile.mobile_number || 'No phone'}</div>
                            <div class="profile-meta">
                                <span>Age: ${calculateAge(profile.date_of_birth) || 'N/A'}</span>
                                <span>Joined: ${formatDate(profile.created_at)}</span>
                            </div>
                        </div>
                        <div class="profile-actions">
                            ${getApprovalStatus(profile.admin_approved)}
                            <button class="btn btn-secondary btn-sm" onclick="viewProfile('${profile.id}')">
                                <i class="fas fa-eye"></i>
                                View
                            </button>
                        </div>
                    </div>
                    
                    <div class="profile-details">
                        <div class="detail-item">
                            <div class="detail-label">Location</div>
                            <div class="detail-value">${profile.city || 'Not specified'}, ${profile.country || ''}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Education</div>
                            <div class="detail-value">${profile.education_level || 'Not specified'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Occupation</div>
                            <div class="detail-value">${profile.occupation || 'Not specified'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">About</div>
                            <div class="detail-value">${truncateText(profile.about_me || 'No bio available', 100)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Last Updated</div>
                            <div class="detail-value">${formatTimeAgo(profile.updated_at)}</div>
                        </div>
                    </div>

                    <div class="profile-actions" style="margin-top: 16px; gap: 8px;">
                        ${profile.admin_approved === null ? `
                            <button class="btn btn-primary btn-sm" onclick="approveProfile('${profile.id}')">
                                <i class="fas fa-check"></i>
                                Approve
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="rejectProfile('${profile.id}')">
                                <i class="fas fa-times"></i>
                                Reject
                            </button>
                        ` : ''}
                        <button class="btn btn-secondary btn-sm" onclick="viewMedia('${profile.id}')">
                            <i class="fas fa-images"></i>
                            Media
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteProfile('${profile.id}')">
                            <i class="fas fa-trash"></i>
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');

            // Update count and render pagination
            const countEl = document.getElementById('profilesCount');
            if (countEl) countEl.textContent = `(${filteredProfiles.length})`;
            renderPagination(totalPages);
        }

        function renderPagination(totalPages) {
            const container = document.getElementById('paginationContainer');
            
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            const pagination = createPagination(currentPage, totalPages, (page) => {
                currentPage = page;
                renderProfiles();
            });

            container.innerHTML = '';
            container.appendChild(pagination);
        }

        function getInitials(firstName, lastName) {
            const first = firstName ? firstName.charAt(0).toUpperCase() : '';
            const last = lastName ? lastName.charAt(0).toUpperCase() : '';
            return first + last || '?';
        }

        function getApprovalStatus(status) {
            if (status === true) {
                return '<span class="approval-status approved"><i class="fas fa-check"></i> Approved</span>';
            } else if (status === false) {
                return '<span class="approval-status rejected"><i class="fas fa-times"></i> Rejected</span>';
            } else {
                return '<span class="approval-status pending"><i class="fas fa-clock"></i> Pending</span>';
            }
        }

        function normalizePackageType(value) {
            if (!value) return 'free';
            const v = String(value).toLowerCase();
            if (v.includes('gold')) return 'golden';
            if (v.includes('vip')) return 'vip';
            if (v.includes('prem')) return 'premium';
            return 'free';
        }

        function getPackageClass(pkg) {
            switch (normalizePackageType(pkg)) {
                case 'premium': return 'package-premium';
                case 'vip': return 'package-vip';
                case 'golden': return 'package-golden';
                default: return 'package-free';
            }
        }

        function getPackageCrown(pkg) {
            const type = normalizePackageType(pkg);
            if (type === 'premium') return '<span class="package-badge"><i class="fas fa-crown"></i> Premium</span>';
            if (type === 'vip') return '<span class="package-badge"><i class="fas fa-crown"></i> VIP Premium</span>';
            if (type === 'golden') return '<span class="package-badge"><i class="fas fa-crown"></i> Golden Premium</span>';
            return '';
        }

        function truncateText(text, maxLength) {
            if (!text || text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        function calculateAge(dateOfBirth) {
            if (!dateOfBirth) return null;
            const today = new Date();
            const birthDate = new Date(dateOfBirth);
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }

        function openAvatarFullscreen(url, alt) {
            const overlay = document.createElement('div');
            overlay.className = 'image-modal-overlay';
            overlay.innerHTML = `
                <div class="image-modal-content" onclick="this.parentNode.remove()">
                    <img src="${url}" alt="${alt}">
                </div>
            `;
            overlay.onclick = function(e) {
                if (e.target === overlay) overlay.remove();
            };
            document.body.appendChild(overlay);
        }

        async function approveProfile(profileId) {
            try {
                // Always use real data
                
                // Real mode
                const { error } = await window.supabaseClient
                    .from('user_profiles')
                    .update({ admin_approved: true })
                    .eq('id', profileId);

                if (error) throw error;

                showNotification('Profile approved successfully', 'success');
                loadProfiles();
            } catch (error) {
                console.error('Error approving profile:', error);
                showNotification('Error approving profile', 'error');
            }
        }

        async function rejectProfile(profileId) {
            try {
                // Always use real data
                
                // Real mode
                const { error } = await window.supabaseClient
                    .from('user_profiles')
                    .update({ admin_approved: false })
                    .eq('id', profileId);

                if (error) throw error;

                showNotification('Profile rejected', 'success');
                loadProfiles();
            } catch (error) {
                console.error('Error rejecting profile:', error);
                showNotification('Error rejecting profile', 'error');
            }
        }

        function deleteProfile(profileId) {
            confirmAction(
                'Are you sure you want to delete this profile? This action cannot be undone.',
                async () => {
                    try {
                        // Always use real data
                        
                        // Real mode
                        const { error } = await window.supabaseClient
                            .from('user_profiles')
                            .delete()
                            .eq('id', profileId);

                        if (error) throw error;

                        showNotification('Profile deleted successfully', 'success');
                        loadProfiles();
                    } catch (error) {
                        console.error('Error deleting profile:', error);
                        showNotification('Error deleting profile', 'error');
                    }
                }
            );
        }

        function viewProfile(profileId) {
            // Find profile
            const profile = profiles.find(p => p.id === profileId);
            if (!profile) return;

            // Create modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-header">
                        <h3>${profile.first_name} ${profile.last_name}</h3>
                        <button class="close-btn" onclick="this.closest('.modal-overlay').remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="profile-details">
                            <div class="detail-item">
                                <div class="detail-label">Email</div>
                                <div class="detail-value">${profile.email}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Age</div>
                                <div class="detail-value">${profile.age || 'Not specified'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Location</div>
                                <div class="detail-value">${profile.location || 'Not specified'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Bio</div>
                                <div class="detail-value">${profile.bio || 'No bio available'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Approval Status</div>
                                <div class="detail-value">${getApprovalStatus(profile.admin_approved)}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Joined</div>
                                <div class="detail-value">${formatDateTime(profile.created_at)}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Last Updated</div>
                                <div class="detail-value">${formatDateTime(profile.updated_at)}</div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        ${profile.admin_approved === null ? `
                            <button class="btn btn-primary" onclick="approveProfile('${profile.id}'); this.closest('.modal-overlay').remove();">
                                <i class="fas fa-check"></i>
                                Approve
                            </button>
                            <button class="btn btn-danger" onclick="rejectProfile('${profile.id}'); this.closest('.modal-overlay').remove();">
                                <i class="fas fa-times"></i>
                                Reject
                            </button>
                        ` : ''}
                        <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">
                            Close
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        async function viewMedia(profileId) {
            try {
                const profile = profiles.find(p => p.id === profileId);
                if (!profile || !profile.user_id) {
                    showNotification('User not found for this profile', 'error');
                    return;
                }
                let photos = [];
                let videos = [];
                const { data: mediaRows, error } = await window.supabaseClient
                    .from('media_references')
                    .select('id, media_type, external_url, thumbnail_url, upload_date, created_at')
                    .eq('user_id', profile.user_id)
                    .order('upload_date', { ascending: false })
                    .order('created_at', { ascending: false });
                if (!error && mediaRows) {
                    photos = mediaRows.filter(m => m.media_type === 'photo');
                    videos = mediaRows.filter(m => m.media_type === 'video');
                }

                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>Media Library</h3>
                                <button class="close-btn" onclick="this.closest('.modal-overlay').remove()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div class="tabs">
                                    <button class="tab-btn active" data-tab="photos" onclick="switchMediaTab(this, 'photos')"><i class="fas fa-image"></i> Photos (${photos.length})</button>
                                    <button class="tab-btn" data-tab="videos" onclick="switchMediaTab(this, 'videos')"><i class="fas fa-video"></i> Videos (${videos.length})</button>
                                </div>
                                <div id="media-photos" class="media-grid">
                                    ${photos.map(p => `
                                        <div class="media-card">
                                            <img src="${p.external_url}" alt="photo" />
                                            <button class="media-delete" onclick="deleteMedia('${p.id}', '${profileId}')"><i class="fas fa-trash"></i></button>
                                        </div>
                                    `).join('')}
                                </div>
                                <div id="media-videos" class="media-grid" style="display:none;">
                                    ${videos.map(v => `
                                        <div class="media-card">
                                            <video src="${v.external_url}" controls poster="${v.thumbnail_url || ''}"></video>
                                            <button class="media-delete" onclick="deleteMedia('${v.id}', '${profileId}')"><i class="fas fa-trash"></i></button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Close</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (e) {
                console.error('Media modal error:', e);
                showNotification('Failed to load media', 'error');
            }
        }

        function switchMediaTab(buttonEl, tab) {
            const container = buttonEl.closest('.modal-content');
            container.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            buttonEl.classList.add('active');
            container.querySelector('#media-photos').style.display = tab === 'photos' ? 'grid' : 'none';
            container.querySelector('#media-videos').style.display = tab === 'videos' ? 'grid' : 'none';
        }

        async function deleteMedia(mediaId, profileId) {
            confirmAction('Delete this media?', async () => {
                try {
                    const { error } = await window.supabaseClient
                        .from('user_media')
                        .delete()
                        .eq('id', mediaId);
                    if (error) throw error;
                    showNotification('Media deleted', 'success');
                    document.querySelector('.modal-overlay').remove();
                    viewMedia(profileId);
                } catch (e) {
                    console.error('Delete media error:', e);
                    showNotification('Failed to delete media', 'error');
                }
            });
        }

        // Removed grid/list toggle; list view enforced

        const handleSearch = debounce(() => {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            applyFilters();
        }, 300);

        function handleFilter() {
            applyFilters();
        }

        function applyFilters() {
            const getVal = (id) => { const el = document.getElementById(id); return el ? el.value : ''; };
            const searchTerm = (getVal('searchInput') || '').toLowerCase().trim();
            const approvalFilter = getVal('approvalFilter');
            const ageFilter = getVal('ageFilter');
            const dateFilter = getVal('dateFilter');
            const packageFilter = getVal('packageFilter');
            const paymentFilter = getVal('paymentFilter');

            const includes = (v) => (typeof v === 'string') && v.toLowerCase().includes(searchTerm);

            filteredProfiles = profiles.filter(profile => {
                // search across fields
                const matchesSearch = !searchTerm ||
                    includes(profile.first_name) || includes(profile.last_name) ||
                    includes(profile.city) || includes(profile.country) ||
                    includes(profile.occupation) || includes(profile.about_me) ||
                    String(profile.mobile_number || '').includes(searchTerm);

                // approval
                let matchesApproval = true;
                if (approvalFilter === 'approved') matchesApproval = profile.admin_approved === true;
                else if (approvalFilter === 'rejected' || approvalFilter === 'denied') matchesApproval = profile.admin_approved === false;
                else if (approvalFilter === 'pending') matchesApproval = profile.admin_approved === null;

                // age from date_of_birth
                let matchesAge = true;
                if (ageFilter) {
                    const age = calculateAge(profile.date_of_birth);
                    if (typeof age === 'number') {
                        if (ageFilter === '18-25') matchesAge = age >= 18 && age <= 25;
                        else if (ageFilter === '26-35') matchesAge = age >= 26 && age <= 35;
                        else if (ageFilter === '36-45') matchesAge = age >= 36 && age <= 45;
                        else if (ageFilter === '46+') matchesAge = age >= 46;
                    }
                }

                // joined date
                let matchesDate = true;
                if (dateFilter) {
                    const d = new Date(profile.created_at);
                    const now = new Date();
                    if (dateFilter === 'today') {
                        const start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        matchesDate = d >= start;
                    } else if (dateFilter === 'week') {
                        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        matchesDate = d >= weekAgo;
                    } else if (dateFilter === 'month') {
                        const monthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
                        matchesDate = d >= monthAgo;
                    }
                }

                // package
                let matchesPackage = true;
                if (packageFilter) {
                    matchesPackage = normalizePackageType(profile.package_type) === packageFilter;
                }

                // payment status
                let matchesPayment = true;
                if (paymentFilter) {
                    const s = (profile.payment_status || '').toLowerCase();
                    matchesPayment = s === paymentFilter;
                }

                return matchesSearch && matchesApproval && matchesAge && matchesDate && matchesPackage && matchesPayment;
            });

            currentPage = 1;
            const countEl = document.getElementById('profilesCount');
            if (countEl) countEl.textContent = `(${filteredProfiles.length})`;
            renderProfiles();
        }

        function clearFilters() {
            ['searchInput','approvalFilter','ageFilter','dateFilter','packageFilter','paymentFilter'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            applyFilters();
        }

        function exportProfiles() {
            if (filteredProfiles.length === 0) {
                showNotification('No profiles to export', 'warning');
                return;
            }

            const exportData = filteredProfiles.map(profile => ({
                'First Name': profile.first_name,
                'Last Name': profile.last_name,
                'Email': profile.email,
                'Age': profile.age || '',
                'Location': profile.location || '',
                'Bio': profile.bio || '',
                'Approval Status': profile.admin_approved === true ? 'Approved' : 
                                  profile.admin_approved === false ? 'Rejected' : 'Pending',
                'Joined Date': formatDate(profile.created_at),
                'Last Updated': formatDate(profile.updated_at)
            }));

            exportToCSV(exportData, `male-profiles-${new Date().toISOString().split('T')[0]}.csv`);
        }
    </script>
</body>
</html>

