<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Packages - Zawajplus Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="admin-translations.js"></script>
    <link rel="stylesheet" href="admin-styles.css">
    <style>
        .table-actions-inline select {
            padding: 4px 8px;
            font-size: 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: #fff;
        }
        .status-badge { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:600; }
        .status-completed { background:#dcfce7; color:#16a34a; }
        .status-pending { background:#fef3c7; color:#d97706; }
        .status-failed { background:#fee2e2; color:#dc2626; }
        .status-refunded { background:#e0e7ff; color:#4338ca; }
        .status-null { background:#f3f4f6; color:#6b7280; }
        .complaint-badge { background:#fee2e2; color:#dc2626; padding:2px 6px; border-radius:6px; font-size:11px; }
        .email-cell .email-link { white-space:nowrap; }
        .filters-inline { display:flex; gap:12px; flex-wrap:wrap; }
        .filters-inline .filter-group { min-width: 180px; }
        .user-name { font-weight:600; color:#1f2937; }
        .user-meta { color:#6b7280; font-size:12px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
        .date-small { font-size: 11px; color:#6b7280; }
    </style>
    
    
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-shield-alt"></i>
                    <span>Zawajplus Admin</span>
                </div>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="/admin-dashboard.html" class="nav-link">
                        <i class="fas fa-tachometer-alt"></i>
                        <span data-translate="admin.navigation.dashboard">Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin-female-profiles.html" class="nav-link">
                        <i class="fas fa-female"></i>
                        <span data-translate="admin.navigation.female_profiles">Female Profiles</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin-male-profiles.html" class="nav-link">
                        <i class="fas fa-male"></i>
                        <span data-translate="admin.navigation.male_profiles">Male Profiles</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin-interests.html" class="nav-link">
                        <i class="fas fa-heart"></i>
                        <span data-translate="admin.navigation.interests">Interests</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin-meet-requests.html" class="nav-link">
                        <i class="fas fa-video"></i>
                        <span data-translate="admin.navigation.meet_requests">Meet Requests</span>
                    </a>
                </li>
                <li class="nav-item active">
                    <a href="/admin-packages.html" class="nav-link">
                        <i class="fas fa-box"></i>
                        <span data-translate="admin.navigation.packages">Packages</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/admin-support-team.html" class="nav-link">
                        <i class="fas fa-headset"></i>
                        <span data-translate="admin.navigation.support_team">Support Team</span>
                    </a>
                </li>
            </ul>
            
            <!-- Language Selector in Sidebar -->
            <div class="sidebar-language-selector">
                <div class="language-dropdown">
                    <button type="button" class="language-btn" onclick="toggleLanguageMenu()">
                        <span id="currentLanguage">English</span>
                        <i class="fas fa-chevron-down" style="font-size: 10px;"></i>
                    </button>
                    <div class="language-menu" id="languageMenu">
                        <div class="language-option active" data-lang="en" onclick="changeLanguage('en')">
                            <span>English</span>
                        </div>
                        <div class="language-option" data-lang="ar" onclick="changeLanguage('ar')">
                            <span>العربية</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-footer">
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span data-translate="admin.navigation.logout">Logout</span>
                </button>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <header class="top-bar">
                <div class="top-bar-left">
                    <button class="sidebar-toggle" onclick="toggleSidebar()">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title" data-translate="admin.packages.title">Packages</h1>
                </div>
                <div class="top-bar-right">
                    <div class="admin-info">
                        <div class="admin-details">
                            <span class="admin-name" id="adminName">Loading...</span>
                            <span class="admin-role" id="adminRole">Admin</span>
                        </div>
                        <div class="admin-avatar">
                            <i class="fas fa-user-circle"></i>
                        </div>
                    </div>
                </div>
            </header>

            <div class="content-area">
                <div class="filters-section">
                    <div class="filters-inline">
                        <div class="filter-group" style="flex:1; min-width:260px;">
                            <label class="filter-label" data-translate="admin.packages.filters.search_label">Search</label>
                            <input type="text" id="searchInput" class="filter-input" placeholder="Search by user, package, status, email..." data-translate-placeholder="admin.packages.filters.search_placeholder" oninput="handleSearch()" />
                        </div>
                        <div class="filter-group">
                            <label class="filter-label" data-translate="admin.packages.filters.status_label">Payment Status</label>
                            <select id="statusFilter" class="filter-select" onchange="applyFilters()">
                                <option value="" data-translate="admin.dashboard.filters.all">All</option>
                                <option value="completed" data-translate="admin.packages.status.completed">Completed</option>
                                <option value="pending" data-translate="admin.packages.status.pending">Pending</option>
                                <option value="failed" data-translate="admin.packages.status.failed">Failed</option>
                                <option value="refunded" data-translate="admin.packages.status.refunded">Refunded</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label" data-translate="admin.packages.filters.package_label">Package Name</label>
                            <select id="packageFilter" class="filter-select" onchange="applyFilters()">
                                <option value="" data-translate="admin.dashboard.filters.all">All</option>
                                <option value="free" data-translate="admin.packages.filters.free">Free</option>
                                <option value="premium" data-translate="admin.packages.filters.premium">Premium</option>
                                <option value="vip" data-translate="admin.packages.filters.vip">VIP Premium</option>
                                <option value="golden" data-translate="admin.packages.filters.golden">Golden Premium</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label" data-translate="admin.packages.filters.updated_label">Updated</label>
                            <select id="updatedFilter" class="filter-select" onchange="applyFilters()">
                                <option value="all" data-translate="admin.packages.filters.all_time">All Time</option>
                                <option value="today" data-translate="admin.packages.filters.today">Today</option>
                                <option value="7" data-translate="admin.packages.filters.last_7_days">Last 7 Days</option>
                                <option value="30" data-translate="admin.packages.filters.last_30_days">Last 30 Days</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label" data-translate="admin.packages.filters.complaints_label">Complaints</label>
                            <select id="complaintsFilter" class="filter-select" onchange="applyFilters()">
                                <option value="" data-translate="admin.dashboard.filters.all">All</option>
                                <option value="yes" data-translate="admin.packages.filters.yes">Yes</option>
                                <option value="no" data-translate="admin.packages.filters.no">No</option>
                            </select>
                        </div>
                    </div>
                    <div class="filters-actions">
                        <button class="btn btn-secondary btn-sm" onclick="resetFilters()"><i class="fas fa-eraser"></i> <span data-translate="admin.packages.buttons.reset_filters">Reset Filters</span></button>
                    </div>
                </div>

                <div class="data-table">
                    <div class="table-header">
                        <div class="table-title"><span data-translate="admin.packages.title">Payment Records</span> <span id="recordsCount"></span></div>
                        <div class="table-actions">
                            <button class="btn btn-secondary btn-sm" onclick="reload()"><i class="fas fa-sync-alt"></i> <span data-translate="admin.packages.buttons.refresh">Refresh</span></button>
                        </div>
                    </div>
                    <div style="overflow-x:auto;">
                        <table class="table" id="packagesTable">
                            <thead>
                                <tr>
                                    <th data-translate="admin.packages.table.user">User</th>
                                    <th data-translate="admin.packages.filters.package_label">Package Name</th>
                                    <th data-translate="admin.packages.filters.status_label">Payment Status</th>
                                    <th data-translate="admin.packages.filters.updated_label">Updated</th>
                                    <th data-translate="admin.packages.table.created">Created</th>
                                    <th data-translate="admin.packages.filters.complaints_label">Complaints</th>
                                </tr>
                            </thead>
                            <tbody id="packagesTbody">
                                <tr><td colspan="6">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination-container" id="paginationContainer"></div>
                </div>
            </div>
        </main>
    </div>

    <script src="admin-common.js"></script>
    <script>
        let allRecords = [];
        let filtered = [];
        let currentPage = 1;
        let itemsPerPage = 15;
        let userProfileById = new Map();

        document.addEventListener('DOMContentLoaded', () => {
            loadAdminInfo();
            fetchRecords();
        });

        async function fetchRecords() {
            const tbody = document.getElementById('packagesTbody');
            tbody.innerHTML = `<tr><td colspan="6">${translateText('admin.packages.messages.loading')}</td></tr>`;
            try {
                // Read payment_records
                const { data, error } = await window.supabaseClient
                    .from('payment_records')
                    .select('id, user_id, package_type, status, updated_at, created_at, complaints')
                    .order('updated_at', { ascending: false })
                    .limit(1000);
                if (error) throw error;
                allRecords = data || [];
                // Fetch user names and phones
                const ids = Array.from(new Set((allRecords||[]).map(r => r.user_id).filter(Boolean)));
                userProfileById.clear();
                if (ids.length){
                    const { data: profs } = await window.supabaseClient
                        .from('user_profiles')
                        .select('user_id, first_name, last_name, phone_code, mobile_number')
                        .in('user_id', ids);
                    (profs||[]).forEach(p => userProfileById.set(p.user_id, p));
                }
                applyFilters();
            } catch (e) {
                console.error('Load payment_records error:', e);
                const tbody = document.getElementById('packagesTbody');
                tbody.innerHTML = `<tr><td colspan="6">${translateText('admin.packages.messages.failed_to_load_records')}</td></tr>`;
            }
        }

        function reload(){ fetchRecords(); }

        const handleSearch = debounce(() => applyFilters(), 300);

        function resetFilters(){
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('packageFilter').value = '';
            document.getElementById('updatedFilter').value = 'all';
            document.getElementById('complaintsFilter').value = '';
            applyFilters();
        }

        function applyFilters() {
            const q = (document.getElementById('searchInput').value || '').toLowerCase().trim();
            const status = document.getElementById('statusFilter').value;
            const pkg = document.getElementById('packageFilter').value;
            const upd = document.getElementById('updatedFilter').value;
            const complaints = document.getElementById('complaintsFilter').value;

            const now = new Date();
            const start = (() => {
                if (upd === 'today') return new Date(now.getFullYear(), now.getMonth(), now.getDate());
                if (upd === '7') return new Date(now.getTime() - 7*24*3600*1000);
                if (upd === '30') return new Date(now.getTime() - 30*24*3600*1000);
                return null;
            })();

            filtered = allRecords.filter(r => {
                const email = (window.getCachedEmailForUser && window.getCachedEmailForUser(r.user_id)) ? window.getCachedEmailForUser(r.user_id).toLowerCase() : '';
                const hasComplaints = r.complaints !== null && r.complaints !== undefined;
                const statusStr = (r.status === null ? 'null' : String(r.status)).toLowerCase();
                const pkgStr = (r.package_type || '').toLowerCase();
                const updatedAt = new Date(r.updated_at);

                // search
                const matchesSearch = !q ||
                    (r.user_id || '').toLowerCase().includes(q) ||
                    pkgStr.includes(q) ||
                    statusStr.includes(q) ||
                    email.includes(q);

                // status
                let matchesStatus = true;
                if (status) {
                    if (status === 'null') matchesStatus = r.status === null;
                    else matchesStatus = statusStr === status;
                }

                // package
                let matchesPkg = true;
                if (pkg) {
                    const norm = normalizePackage(pkgStr);
                    matchesPkg = norm === pkg;
                }

                // updated window
                let matchesUpdated = true;
                if (start) matchesUpdated = updatedAt >= start;

                // complaints (null vs not null)
                let matchesComplaints = true;
                if (complaints === 'yes') matchesComplaints = hasComplaints;
                if (complaints === 'no') matchesComplaints = !hasComplaints;

                return matchesSearch && matchesStatus && matchesPkg && matchesUpdated && matchesComplaints;
            });

            currentPage = 1;
            renderTable();
        }

        function normalizePackage(value){
            const v = String(value||'').toLowerCase();
            if (v.includes('gold')) return 'golden';
            if (v.includes('vip')) return 'vip';
            if (v.includes('prem')) return 'premium';
            return v || 'free';
        }

        function renderTable(){
            const tbody = document.getElementById('packagesTbody');
            if (!filtered.length) {
                tbody.innerHTML = `<tr><td colspan="6">${translateText('admin.packages.messages.no_records')}</td></tr>`;
                document.getElementById('recordsCount').textContent = '(0)';
                document.getElementById('paginationContainer').innerHTML='';
                return;
            }
            const totalPages = Math.ceil(filtered.length / itemsPerPage);
            const start = (currentPage-1)*itemsPerPage;
            const rows = filtered.slice(start, start+itemsPerPage);
            tbody.innerHTML = rows.map(r => {
                const pkg = normalizePackage(r.package_type);
                const status = (r.status===null?'null':String(r.status).toLowerCase());
                const statusClass = status==='completed'?'status-completed':status==='pending'?'status-pending':status==='failed'?'status-failed':status==='refunded'?'status-refunded':'status-null';
                const complaintsHtml = formatComplaint(r.complaints);
                const prof = userProfileById.get(r.user_id) || {};
                const displayName = [prof.first_name, prof.last_name].filter(Boolean).join(' ') || r.user_id;
                const phone = formatPhone(prof.phone_code, prof.mobile_number);
                return `
                    <tr>
                        <td class="email-cell">
                            <div class="user-name">${displayName}</div>
                            <div class="user-meta">
                                <span class="email-link" data-user-id="${r.user_id}"></span>
                                ${phone ? `<a href="https://wa.me/${phone.replace(/\\+/g,'')}" target="_blank">${phone}</a>` : ''}
                            </div>
                        </td>
                        <td class="table-actions-inline">
                            <select onchange="updatePackageType('${r.id}', this.value)">
                                <option value="free" ${pkg==='free'?'selected':''}>${translateText('admin.packages.filters.free')}</option>
                                <option value="premium" ${pkg==='premium'?'selected':''}>${translateText('admin.packages.filters.premium')}</option>
                                <option value="vip" ${pkg==='vip'?'selected':''}>${translateText('admin.packages.filters.vip')}</option>
                                <option value="golden" ${pkg==='golden'?'selected':''}>${translateText('admin.packages.filters.golden')}</option>
                            </select>
                        </td>
                        <td class="table-actions-inline">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <span class="status-badge ${statusClass}">${status}</span>
                                <select onchange="updateStatus('${r.id}', this.value)">
                                    <option value="completed" ${status==='completed'?'selected':''}>${translateText('admin.packages.status.completed')}</option>
                                    <option value="pending" ${status==='pending'?'selected':''}>${translateText('admin.packages.status.pending')}</option>
                                    <option value="failed" ${status==='failed'?'selected':''}>${translateText('admin.packages.status.failed')}</option>
                                    <option value="refunded" ${status==='refunded'?'selected':''}>${translateText('admin.packages.status.refunded')}</option>
                                </select>
                            </div>
                        </td>
                        <td><span class="date-small">${formatDateTime(r.updated_at)}</span></td>
                        <td><span class="date-small">${formatDateTime(r.created_at)}</span></td>
                        <td>${complaintsHtml || '-'}</td>
                    </tr>
                `;
            }).join('');

            if (window.fillEmailsForElements) window.fillEmailsForElements(document.getElementById('packagesTable'));
            document.getElementById('recordsCount').textContent = `(${filtered.length})`;
            const cont = document.getElementById('paginationContainer');
            cont.innerHTML = '';
            cont.appendChild(createPagination(currentPage, totalPages, (p)=>{ currentPage=p; renderTable(); }));
        }

        function digitsOnly(v){ return (v||'').toString().replace(/\D/g,''); }
        function formatPhone(code, number){
            const c = digitsOnly(code); let n = digitsOnly(number);
            if (!c && !n) return '';
            if (c){ n = n.replace(/^0+/, ''); return `+${c}${n}`; }
            if (n.startsWith('00')) n = n.slice(2); return `+${n}`;
        }

        function formatComplaint(val){
            if (val === null || val === undefined) return '';
            try {
                if (Array.isArray(val)) {
                    if (val.length === 0) return '';
                    const parts = val.slice(0, 3).map(v => complaintItemToText(v));
                    return parts.map(p => `<span class="complaint-badge" title="${escapeHtml(p)}">${escapeHtml(truncateText(p, 60))}</span>`).join(' ');
                }
                const text = complaintItemToText(val);
                return `<span class="complaint-badge" title="${escapeHtml(text)}">${escapeHtml(truncateText(text, 60))}</span>`;
            } catch { return ''; }
        }
        function complaintItemToText(v){
            if (v === null || v === undefined) return '';
            if (typeof v === 'string') return v;
            if (typeof v === 'object') {
                // Try common fields
                for (const k of ['message','reason','note','details','complaint','text','description']){
                    if (v && typeof v[k] === 'string' && v[k]) return v[k];
                }
                return JSON.stringify(v);
            }
            return String(v);
        }
        function truncateText(t, n){ try { return t.length>n ? t.slice(0,n)+'…' : t; } catch { return t; } }
        function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

        async function updatePackageType(id, value){
            try{
                const { error } = await window.supabaseClient
                    .from('payment_records')
                    .update({ package_type: value })
                    .eq('id', id);
                if (error) throw error;
                showNotification(translateText('admin.packages.notifications.package_updated'), 'success');
                fetchRecords();
            }catch(e){
                console.error(e);
                showNotification(translateText('admin.packages.notifications.update_package_failed'), 'error');
                fetchRecords();
            }
        }
        async function updateStatus(id, value){
            try{
                const statusVal = (value==='null')? null : value;
                const { error } = await window.supabaseClient
                    .from('payment_records')
                    .update({ status: statusVal })
                    .eq('id', id);
                if (error) throw error;
                showNotification(translateText('admin.packages.notifications.status_updated'), 'success');
                fetchRecords();
            }catch(e){
                console.error(e);
                showNotification(translateText('admin.packages.notifications.update_status_failed'), 'error');
                fetchRecords();
            }
        }
    </script>
</body>
</html>


