<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meet Requests - Zawajplus Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="admin-translations.js"></script>
    <link rel="stylesheet" href="admin-styles.css">
    <style>
        .filters-inline { display:flex; gap:12px; flex-wrap:wrap; }
        .filters-inline .filter-group { min-width: 180px; }
        .user-name { font-weight:600; color:#1f2937; }
        .user-meta { color:#6b7280; font-size:12px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
        .date-small { font-size: 11px; color:#6b7280; }
        .status-badge { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:600; }
        .status-accepted { background:#dcfce7; color:#16a34a; }
        .status-rejected { background:#fee2e2; color:#dc2626; }
        .status-pending { background:#fef3c7; color:#d97706; }
        .status-null { background:#f3f4f6; color:#6b7280; }
        .table-actions-inline select { padding: 4px 8px; font-size: 12px; border: 1px solid #d1d5db; border-radius: 6px; background: #fff; }
    </style>
</head>
<body>
    <div class="admin-layout">
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-shield-alt"></i>
                    <span>Zawajplus Admin</span>
                </div>
            </div>
            <ul class="nav-menu">
                <li class="nav-item"><a href="/admin-dashboard.html" class="nav-link"><i class="fas fa-tachometer-alt"></i><span data-translate="admin.navigation.dashboard">Dashboard</span></a></li>
                <li class="nav-item"><a href="/admin-female-profiles.html" class="nav-link"><i class="fas fa-female"></i><span data-translate="admin.navigation.female_profiles">Female Profiles</span></a></li>
                <li class="nav-item"><a href="/admin-male-profiles.html" class="nav-link"><i class="fas fa-male"></i><span data-translate="admin.navigation.male_profiles">Male Profiles</span></a></li>
                <li class="nav-item"><a href="/admin-interests.html" class="nav-link"><i class="fas fa-heart"></i><span data-translate="admin.navigation.interests">Interests</span></a></li>
                <li class="nav-item active"><a href="/admin-meet-requests.html" class="nav-link"><i class="fas fa-video"></i><span data-translate="admin.navigation.meet_requests">Meet Requests</span></a></li>
                <li class="nav-item"><a href="/admin-whatsapp-requests.html" class="nav-link"><i class="fab fa-whatsapp"></i><span data-translate="admin.navigation.whatsapp_requests">WhatsApp Requests</span></a></li>
                <li class="nav-item"><a href="/admin-packages.html" class="nav-link"><i class="fas fa-box"></i><span data-translate="admin.navigation.packages">Packages</span></a></li>
                <li class="nav-item"><a href="/admin-support-team.html" class="nav-link"><i class="fas fa-headset"></i><span data-translate="admin.navigation.support_team">Support Team</span></a></li>
            </ul>

            <!-- Language Selector in Sidebar -->
            <div class="sidebar-language-selector">
                <div class="language-dropdown">
                    <button type="button" class="language-btn" onclick="toggleLanguageMenu()">
                        <span id="currentLanguage">English</span>
                        <i class="fas fa-chevron-down" style="font-size: 10px;"></i>
                    </button>
                    <div class="language-menu" id="languageMenu">
                        <div class="language-option active" data-lang="en" onclick="changeLanguage('en')">
                            <span>English</span>
                        </div>
                        <div class="language-option" data-lang="ar" onclick="changeLanguage('ar')">
                            <span>العربية</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sidebar-footer">
                <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i><span data-translate="admin.navigation.logout">Logout</span></button>
            </div>
        </nav>

        <main class="main-content">
            <header class="top-bar">
                <div class="top-bar-left">
                    <button class="sidebar-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
                    <h1 class="page-title" data-translate="admin.meet_requests.title">Meet Requests</h1>
                </div>
                <div class="top-bar-right">
                    <div class="admin-info">
                        <div class="admin-details">
                            <span class="admin-name" id="adminName">Loading...</span>
                            <span class="admin-role" id="adminRole">Admin</span>
                        </div>
                        <div class="admin-avatar"><i class="fas fa-user-circle"></i></div>
                    </div>
                </div>
            </header>

            <div class="content-area">
                <div class="filters-section">
                    <div class="filters-inline">
                        <div class="filter-group" style="flex:1; min-width:260px;">
                            <label class="filter-label" data-translate="admin.meet_requests.filters.search_label">Search</label>
                            <input type="text" id="searchInput" class="filter-input" placeholder="Search by sender, receiver, email..." data-translate-placeholder="admin.meet_requests.filters.search_placeholder" oninput="handleSearch()" />
                        </div>
                        <div class="filter-group">
                            <label class="filter-label" data-translate="admin.meet_requests.filters.status_label">Status</label>
                            <select id="statusFilter" class="filter-select" onchange="applyFilters()">
                                <option value="" data-translate="admin.meet_requests.filters.all">All</option>
                                <option value="accepted" data-translate="admin.meet_requests.status.accepted">Accepted</option>
                                <option value="rejected" data-translate="admin.meet_requests.status.rejected">Rejected</option>
                                <option value="pending" data-translate="admin.meet_requests.status.pending">Pending</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label" data-translate="admin.meet_requests.filters.time_label">Time</label>
                            <select id="timeFilter" class="filter-select" onchange="applyFilters()">
                                <option value="all" data-translate="admin.meet_requests.filters.all_time">All Time</option>
                                <option value="today" data-translate="admin.meet_requests.filters.today">Today</option>
                                <option value="7" data-translate="admin.meet_requests.filters.last_7_days">Last 7 Days</option>
                                <option value="30" data-translate="admin.meet_requests.filters.last_30_days">Last 30 Days</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label" data-translate="admin.meet_requests.filters.scheduled_label">Scheduled</label>
                            <select id="scheduledFilter" class="filter-select" onchange="applyFilters()">
                                <option value="" data-translate="admin.meet_requests.filters.scheduled_any">Any</option>
                                <option value="today" data-translate="admin.meet_requests.filters.scheduled_today">Today</option>
                                <option value="yesterday" data-translate="admin.meet_requests.filters.scheduled_yesterday">Yesterday</option>
                                <option value="week" data-translate="admin.meet_requests.filters.scheduled_week">This Week</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label" data-translate="admin.meet_requests.filters.sender_gender">Sender Gender</label>
                            <select id="senderGenderFilter" class="filter-select" onchange="applyFilters()">
                                <option value="" data-translate="admin.meet_requests.filters.all">All</option>
                                <option value="male" data-translate="admin.meet_requests.filters.male">Male</option>
                                <option value="female" data-translate="admin.meet_requests.filters.female">Female</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label" data-translate="admin.meet_requests.filters.receiver_gender">Receiver Gender</label>
                            <select id="receiverGenderFilter" class="filter-select" onchange="applyFilters()">
                                <option value="" data-translate="admin.meet_requests.filters.all">All</option>
                                <option value="male" data-translate="admin.meet_requests.filters.male">Male</option>
                                <option value="female" data-translate="admin.meet_requests.filters.female">Female</option>
                            </select>
                        </div>
                    </div>
                    <div class="filters-actions">
                        <button class="btn btn-secondary btn-sm" onclick="resetFilters()"><i class="fas fa-eraser"></i> <span data-translate="admin.meet_requests.buttons.reset_filters">Reset Filters</span></button>
                    </div>
                </div>

                <div class="data-table">
                    <div class="table-header">
                        <div class="table-title"><span data-translate="admin.meet_requests.title">Meet Requests</span> <span id="recordsCount"></span></div>
                        <div class="table-actions">
                            <button class="btn btn-secondary btn-sm" onclick="reload()"><i class="fas fa-sync-alt"></i> <span data-translate="admin.meet_requests.buttons.refresh">Refresh</span></button>
                        </div>
                    </div>
                    <div style="overflow-x:auto;">
                        <table class="table" id="meetTable">
                            <thead>
                                <tr>
                                    <th data-translate="admin.meet_requests.table.sender">Sender</th>
                                    <th data-translate="admin.meet_requests.table.receiver">Receiver</th>
                                    <th data-translate="admin.meet_requests.table.status">Status</th>
                                    <th data-translate="admin.meet_requests.table.scheduled">Scheduled</th>
                                    <th data-translate="admin.meet_requests.table.created">Created</th>
                                    <th data-translate="admin.meet_requests.table.actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="meetTbody">
                                <tr><td colspan="6">${translateText('admin.meet_requests.messages.loading')}</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination-container" id="paginationContainer"></div>
                </div>
            </div>
        </main>
    </div>

    <script src="admin-common.js"></script>
    <script>
        let allRows = [];
        let filtered = [];
        let currentPage = 1;
        let itemsPerPage = 15;
        const senderProfiles = new Map();
        const receiverProfiles = new Map();

        document.addEventListener('DOMContentLoaded', () => {
            loadAdminInfo();
            fetchRows();
        });

        async function fetchRows(){
            const tbody = document.getElementById('meetTbody');
            tbody.innerHTML = '<tr><td colspan="6">Loading...</td></tr>';
            try{
                const { data, error } = await window.supabaseClient
                    .from('meet_requests')
                    .select('id, sender_id, receiver_id, status, created_at, scheduled_at')
                    .order('created_at', { ascending: false })
                    .limit(1000);
                if (error) throw error;
                allRows = data || [];

                const senderIds = Array.from(new Set(allRows.map(r => r.sender_id)));
                const receiverIds = Array.from(new Set(allRows.map(r => r.receiver_id)));
                senderProfiles.clear();
                receiverProfiles.clear();

                if (senderIds.length){
                    const { data: senders } = await window.supabaseClient
                        .from('user_profiles')
                        .select('user_id, first_name, last_name, phone_code, mobile_number, gender')
                        .in('user_id', senderIds);
                    (senders||[]).forEach(p => senderProfiles.set(p.user_id, p));
                }
                if (receiverIds.length){
                    const { data: receivers } = await window.supabaseClient
                        .from('user_profiles')
                        .select('user_id, first_name, last_name, phone_code, mobile_number, gender')
                        .in('user_id', receiverIds);
                    (receivers||[]).forEach(p => receiverProfiles.set(p.user_id, p));
                }

                applyFilters();
            }catch(e){
                console.error('Load meet_requests error:', e);
                tbody.innerHTML = `<tr><td colspan="6">${translateText('admin.meet_requests.messages.failed_to_load_records')}</td></tr>`;
            }
        }

        function reload(){ fetchRows(); }

        const handleSearch = debounce(() => applyFilters(), 300);

        function resetFilters(){
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('timeFilter').value = 'all';
            document.getElementById('senderGenderFilter').value = '';
            document.getElementById('receiverGenderFilter').value = '';
            applyFilters();
        }

        function applyFilters(){
            const q = (document.getElementById('searchInput').value || '').toLowerCase().trim();
            const status = document.getElementById('statusFilter').value;
            const time = document.getElementById('timeFilter').value;
            const sGender = document.getElementById('senderGenderFilter').value;
            const rGender = document.getElementById('receiverGenderFilter').value;
            const scheduled = document.getElementById('scheduledFilter').value;

            const now = new Date();
            const start = (() => {
                if (time === 'today') return new Date(now.getFullYear(), now.getMonth(), now.getDate());
                if (time === '7') return new Date(now.getTime() - 7*24*3600*1000);
                if (time === '30') return new Date(now.getTime() - 30*24*3600*1000);
                return null;
            })();

            filtered = allRows.filter(r => {
                const s = senderProfiles.get(r.sender_id) || {};
                const rec = receiverProfiles.get(r.receiver_id) || {};
                const sName = [s.first_name, s.last_name].filter(Boolean).join(' ').toLowerCase();
                const rName = [rec.first_name, rec.last_name].filter(Boolean).join(' ').toLowerCase();
                const emailS = (window.getCachedEmailForUser && window.getCachedEmailForUser(r.sender_id)) ? window.getCachedEmailForUser(r.sender_id).toLowerCase() : '';
                const emailR = (window.getCachedEmailForUser && window.getCachedEmailForUser(r.receiver_id)) ? window.getCachedEmailForUser(r.receiver_id).toLowerCase() : '';
                const createdAt = new Date(r.created_at);
                const statusStr = (r.status===null?'null':String(r.status).toLowerCase());

                const matchesSearch = !q || sName.includes(q) || rName.includes(q) || emailS.includes(q) || emailR.includes(q);

                let matchesStatus = true;
                if (status){
                    if (status==='null') matchesStatus = r.status === null;
                    else matchesStatus = statusStr === status;
                }

                let matchesTime = true;
                if (start) matchesTime = createdAt >= start;

                let matchesSG = true; if (sGender) matchesSG = (s.gender||'').toLowerCase() === sGender;
                let matchesRG = true; if (rGender) matchesRG = (rec.gender||'').toLowerCase() === rGender;
                // scheduled filter
                let matchesScheduled = true;
                if (scheduled) {
                    const sched = r.scheduled_at ? new Date(r.scheduled_at) : null;
                    const now2 = new Date();
                    if (scheduled === 'today') {
                        const startDay = new Date(now2.getFullYear(), now2.getMonth(), now2.getDate());
                        const endDay = new Date(now2.getFullYear(), now2.getMonth(), now2.getDate()+1);
                        matchesScheduled = !!sched && sched >= startDay && sched < endDay;
                    } else if (scheduled === 'yesterday') {
                        const startDay = new Date(now2.getFullYear(), now2.getMonth(), now2.getDate()-1);
                        const endDay = new Date(now2.getFullYear(), now2.getMonth(), now2.getDate());
                        matchesScheduled = !!sched && sched >= startDay && sched < endDay;
                    } else if (scheduled === 'week') {
                        const day = now2.getDay();
                        const diffToMonday = (day === 0 ? 6 : day - 1);
                        const startWeek = new Date(now2.getFullYear(), now2.getMonth(), now2.getDate() - diffToMonday);
                        matchesScheduled = !!sched && sched >= startWeek;
                    }
                }

                return matchesSearch && matchesStatus && matchesTime && matchesSG && matchesRG && matchesScheduled;
            });

            currentPage = 1;
            renderTable();
        }

        function renderTable(){
            const tbody = document.getElementById('meetTbody');
            if (!filtered.length){
                tbody.innerHTML = `<tr><td colspan="6">${translateText('admin.meet_requests.messages.no_records')}</td></tr>`;
                document.getElementById('recordsCount').textContent = '(0)';
                document.getElementById('paginationContainer').innerHTML = '';
                return;
            }
            const totalPages = Math.ceil(filtered.length / itemsPerPage);
            const start = (currentPage-1)*itemsPerPage;
            const rows = filtered.slice(start, start+itemsPerPage);
            tbody.innerHTML = rows.map(r => {
                const s = senderProfiles.get(r.sender_id) || {};
                const rec = receiverProfiles.get(r.receiver_id) || {};
                const sName = [s.first_name, s.last_name].filter(Boolean).join(' ') || r.sender_id;
                const rName = [rec.first_name, rec.last_name].filter(Boolean).join(' ') || r.receiver_id;
                const sGenderTag = ((s.gender||'').toLowerCase()==='female') ? '(f)' : '(m)';
                const rGenderTag = ((rec.gender||'').toLowerCase()==='female') ? '(f)' : '(m)';
                const sPhone = formatPhone(s.phone_code, s.mobile_number);
                const rPhone = formatPhone(rec.phone_code, rec.mobile_number);
                const status = (r.status===null?'null':String(r.status).toLowerCase());
                const statusClass = status==='accepted'?'status-accepted':status==='rejected'?'status-rejected':status==='pending'?'status-pending':'status-null';
                return `
                    <tr>
                        <td>
                            <div class="user-name"><a href="/matchdetails?userId=${r.sender_id}" target="_blank">${sName} ${sGenderTag}</a></div>
                            <div class="user-meta">
                                <span class="email-link" data-user-id="${r.sender_id}"></span>
                                ${sPhone ? `<a href=\"https://wa.me/${sPhone.replace(/\\+/g,'')}\" target=\"_blank\">${sPhone}</a>` : ''}
                            </div>
                        </td>
                        <td>
                            <div class="user-name"><a href="/matchdetails?userId=${r.receiver_id}" target="_blank">${rName} ${rGenderTag}</a></div>
                            <div class="user-meta">
                                <span class="email-link" data-user-id="${r.receiver_id}"></span>
                                ${rPhone ? `<a href=\"https://wa.me/${rPhone.replace(/\\+/g,'')}\" target=\"_blank\">${rPhone}</a>` : ''}
                            </div>
                        </td>
                        <td class="table-actions-inline">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <span class="status-badge ${statusClass}">${translateText(`admin.meet_requests.status.${status}`)}</span>
                                <select onchange="updateMeetStatus('${r.id}', this.value)">
                                    <option value="accepted" ${status==='accepted'?'selected':''}>${translateText('admin.meet_requests.status.accepted')}</option>
                                    <option value="rejected" ${status==='rejected'?'selected':''}>${translateText('admin.meet_requests.status.rejected')}</option>
                                    <option value="pending" ${status==='pending'?'selected':''}>${translateText('admin.meet_requests.status.pending')}</option>
                                </select>
                            </div>
                        </td>
                        <td><span class="date-small"><a href="javascript:void(0)" onclick="openScheduleModal('${r.id}','${r.scheduled_at || ''}')">${r.scheduled_at ? formatDateTime(r.scheduled_at) : '<em>-</em>'}</a></span></td>
                        <td><span class="date-small">${formatDateTime(r.created_at)}</span></td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="deleteMeetRequest('${r.id}')" style="padding: 6px 8px; font-size: 14px; background: #dc2626; color: white; border: none; border-radius: 4px; cursor: pointer;" title="Delete Meet Request">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            if (window.fillEmailsForElements) window.fillEmailsForElements(document.getElementById('meetTable'));
            document.getElementById('recordsCount').textContent = `(${filtered.length})`;
            const cont = document.getElementById('paginationContainer');
            cont.innerHTML = '';
            cont.appendChild(createPagination(currentPage, totalPages, (p)=>{ currentPage=p; renderTable(); }));
        }

        function digitsOnly(v){ return (v||'').toString().replace(/\D/g,''); }
        function formatPhone(code, number){
            const c = digitsOnly(code); let n = digitsOnly(number);
            if (!c && !n) return '';
            if (c){ n = n.replace(/^0+/, ''); return `+${c}${n}`; }
            if (n.startsWith('00')) n = n.slice(2); return `+${n}`;
        }

        async function updateMeetStatus(id, value){
            try{
                const statusVal = (value==='null')? null : value;
                const { error } = await window.supabaseClient
                    .from('meet_requests')
                    .update({ status: statusVal })
                    .eq('id', id);
                if (error) throw error;
                showNotification('Status updated', 'success');
                fetchRows();
            }catch(e){
                console.error(e);
                if (window.handleAuthIssue) window.handleAuthIssue(e);
                showNotification('Failed to update status', 'error');
                fetchRows();
            }
        }

        // ================= Edit Schedule Modal =================
        function openScheduleModal(id, iso){
            const title = translateText('admin.meet_requests.edit_schedule_title') || 'Edit Schedule';
            const lTz = translateText('admin.meet_requests.labels.timezone') || 'Time Zone';
            const lDate = translateText('admin.meet_requests.labels.date') || 'Date';
            const lTime = translateText('admin.meet_requests.labels.time') || 'Time';
            const cancelTxt = translateText('admin.common.cancel') || 'Cancel';
            const saveTxt = translateText('admin.common.save') || 'Save';

            // Common offsets
            const tzOptions = [
                { v: '+00:00', n: 'UTC (+00:00)' },
                { v: '+01:00', n: 'UTC+01:00' },
                { v: '+02:00', n: 'UTC+02:00' },
                { v: '+03:00', n: 'UTC+03:00 (Riyadh)' },
                { v: '+04:00', n: 'UTC+04:00' },
                { v: '+05:00', n: 'UTC+05:00' },
                { v: '+05:30', n: 'UTC+05:30 (IST)' },
                { v: '+06:00', n: 'UTC+06:00' },
                { v: '+07:00', n: 'UTC+07:00' },
                { v: '+08:00', n: 'UTC+08:00' },
                { v: '+09:00', n: 'UTC+09:00' },
                { v: '+10:00', n: 'UTC+10:00' },
                { v: '+11:00', n: 'UTC+11:00' },
                { v: '+12:00', n: 'UTC+12:00' },
                { v: '-01:00', n: 'UTC-01:00' },
                { v: '-02:00', n: 'UTC-02:00' },
                { v: '-03:00', n: 'UTC-03:00' },
                { v: '-04:00', n: 'UTC-04:00' },
                { v: '-05:00', n: 'UTC-05:00' },
                { v: '-06:00', n: 'UTC-06:00' },
                { v: '-07:00', n: 'UTC-07:00' },
                { v: '-08:00', n: 'UTC-08:00' },
                { v: '-09:00', n: 'UTC-09:00' },
                { v: '-10:00', n: 'UTC-10:00' },
                { v: '-11:00', n: 'UTC-11:00' },
                { v: '-12:00', n: 'UTC-12:00' }
            ];

            let currentOffset = '+00:00';
            let initDate = '';
            let initTime = '';
            try{
                if (iso){
                    // Try to extract an offset from string if present (+HH:MM or -HH:MM)
                    const m = String(iso).match(/([+-]\d{2}:?\d{2})$/);
                    if (m && m[1]){
                        const raw = m[1].replace(':','');
                        currentOffset = m[1].includes(':') ? m[1] : (m[1].slice(0,3)+':'+m[1].slice(3));
                    }
                    // Convert to local parts based on offset (fallback: UTC)
                    const d = new Date(iso);
                    const offMin = offsetToMinutes(currentOffset);
                    const local = new Date(d.getTime() + offMin * 60000);
                    initDate = local.toISOString().slice(0,10);
                    initTime = local.toISOString().slice(11,16);
                } else {
                    const now = new Date();
                    initDate = now.toISOString().slice(0,10);
                    initTime = now.toISOString().slice(11,16);
                }
            } catch {}

            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
            `;
            modal.innerHTML = `
                <div class="modal-dialog" style="
                    background: white;
                    border-radius: 12px;
                    max-width: 500px;
                    width: 90%;
                    max-height: 90vh;
                    overflow-y: auto;
                ">
                    <div class="modal-content">
                        <div class="modal-header" style="
                            padding: 20px;
                            border-bottom: 1px solid #e5e7eb;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        ">
                            <h3>${title}</h3>
                            <button class="close-btn" onclick="this.closest('.modal-overlay').remove()" style="
                                background: none;
                                border: none;
                                font-size: 20px;
                                color: #6b7280;
                                cursor: pointer;
                            ">×</button>
                        </div>
                        <div class="modal-body" style="padding: 20px; display:grid; gap:16px;">
                            <div style="display:grid; gap:6px;">
                                <label style="font-weight: 600; color: #374151;">${lTz}</label>
                                <select id="mr_tz" class="filter-select" style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 8px;">
                                    ${tzOptions.map(o => `<option value="${o.v}" ${o.v===currentOffset?'selected':''}>${o.n}</option>`).join('')}
                                </select>
                            </div>
                            <div style="display:grid; gap:6px;">
                                <label style="font-weight: 600; color: #374151;">${lDate}</label>
                                <input id="mr_date" type="date" class="filter-input" value="${initDate}" style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 8px;">
                            </div>
                            <div style="display:grid; gap:6px;">
                                <label style="font-weight: 600; color: #374151;">${lTime}</label>
                                <input id="mr_time" type="time" class="filter-input" value="${initTime}" style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 8px;">
                            </div>
                        </div>
                        <div class="modal-footer" style="
                            padding: 20px;
                            border-top: 1px solid #e5e7eb;
                            display: flex;
                            gap: 12px;
                            justify-content: flex-end;
                        ">
                            <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()" style="
                                padding: 8px 16px;
                                border: 1px solid #d1d5db;
                                background: white;
                                color: #374151;
                                border-radius: 8px;
                                cursor: pointer;
                            ">${cancelTxt}</button>
                            <button class="btn btn-primary" onclick="saveSchedule('${id}', this)" style="
                                padding: 8px 16px;
                                background: #3b82f6;
                                color: white;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                                gap: 6px;
                            "><i class="fas fa-save"></i> ${saveTxt}</button>
                        </div>
                    </div>
                </div>`;
            document.body.appendChild(modal);
            
            // Close modal when clicking outside
            modal.onclick = function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            };
        }

        function offsetToMinutes(off){
            // off format "+HH:MM" or "-HH:MM"
            try{
                const sign = off.startsWith('-') ? -1 : 1;
                const [h,m] = off.replace('+','').replace('-','').split(':');
                return sign * (parseInt(h||'0',10)*60 + parseInt(m||'0',10));
            }catch{ return 0; }
        }

        async function saveSchedule(id, btn){
            const root = btn.closest('.modal-content');
            const tz = root.querySelector('#mr_tz')?.value || '+00:00';
            const d = root.querySelector('#mr_date')?.value || '';
            const t = root.querySelector('#mr_time')?.value || '';
            if (!d || !t){ showNotification('Please select date and time', 'warning'); return; }
            try{
                const [yy,mm,dd] = d.split('-').map(v=>parseInt(v,10));
                const [hh,mi] = t.split(':').map(v=>parseInt(v,10));
                // Treat entered values as local in tz, convert to UTC
                const offMin = offsetToMinutes(tz);
                const localUtcMs = Date.UTC(yy, (mm||1)-1, dd||1, hh||0, mi||0, 0, 0);
                const utcMs = localUtcMs - offMin*60000;
                const isoUtc = new Date(utcMs).toISOString();
                const { error } = await window.supabaseClient
                    .from('meet_requests')
                    .update({ scheduled_at: isoUtc })
                    .eq('id', id);
                if (error) throw error;
                showNotification('Schedule updated', 'success');
                document.querySelector('.modal-overlay')?.remove();
                reload();
            } catch(e){
                console.error('Update schedule error', e);
                showNotification('Failed to update schedule', 'error');
            }
        }

        async function deleteMeetRequest(id){
            if (!confirm('Are you sure you want to delete this meet request? This action cannot be undone.')) {
                return;
            }
            try{
                const { error } = await window.supabaseClient
                    .from('meet_requests')
                    .delete()
                    .eq('id', id);
                if (error) throw error;
                showNotification('Meet request deleted successfully', 'success');
                fetchRows();
            }catch(e){
                console.error('Delete meet request error:', e);
                if (window.handleAuthIssue) window.handleAuthIssue(e);
                showNotification('Failed to delete meet request', 'error');
                fetchRows();
            }
        }
    </script>
</body>
</html>

